<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Air Piano Pro | Launch Ready</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" crossorigin="anonymous"></script>
    <style>
        :root { --neon: #00f2ff; --rec: #ff3333; --play: #00ff88; --new: #bf00ff; --stop: #ffa500; --gold: #ffd700; }
        body { margin: 0; background: #000; color: white; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { width: 100vw; height: 100vh; position: absolute; }
        
        /* Menu System */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); z-index: 1000; text-align: center; }
        .hidden { display: none !important; }
        .btn { padding: 15px 40px; border: 2px solid var(--neon); background: transparent; color: var(--neon); cursor: pointer; border-radius: 5px; font-weight: bold; margin: 10px; transition: 0.3s; }
        .btn:hover { background: var(--neon); color: black; box-shadow: 0 0 20px var(--neon); }
        
        /* HUD & Stats */
        #dashboard { position: absolute; top: 20px; left: 20px; border-left: 4px solid var(--neon); padding: 10px; background: rgba(255,255,255,0.05); z-index: 500; }
        #mode-indicator { position: absolute; top: 20px; right: 20px; padding: 10px 20px; border-radius: 5px; font-weight: bold; border: 1px solid var(--neon); z-index: 500; }

        /* Timer/Countdown */
        #countdown-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 800; pointer-events: none; text-align: center; }
        #timer-val { font-size: 9rem; font-weight: bold; }
        #timer-msg { font-size: 1.5rem; letter-spacing: 5px; text-transform: uppercase; }

        /* Mixer & Player */
        .scroll-pane { background: #111; padding: 30px; border-radius: 10px; width: 80%; max-height: 70%; overflow-y: auto; border: 1px solid #333; }
        .slider-row { display: flex; align-items: center; gap: 20px; margin: 15px 0; }
        input[type=range] { flex-grow: 1; accent-color: var(--neon); }
    </style>
</head>
<body>

    <div id="ui-main" class="overlay">
        <h1 style="font-size: 3rem; color: var(--neon);">AIR PIANO PRO</h1>
        <button class="btn" onclick="showScene('how-to')">How To Use</button>
        <button class="btn" onclick="showScene('settings')">Mixer & Settings</button>
        <button class="btn" onclick="showScene('library')">Saved Tunes</button>
        <button class="btn" onclick="enterPlay()">ðŸš€ START PERFORMANCE</button>
    </div>

    <div id="ui-how-to" class="overlay hidden">
        <div class="scroll-pane">
            <h2>MANUAL</h2>
            <p>1. <b>Right Fist (3s):</b> Record / Stop</p>
            <p>2. <b>Left Fist (3s):</b> Play Recorded Loop</p>
            <p>3. <b>Both Fists (5s):</b> Reset / New Session</p>
            <p>4. <b>Prayer Pose (3s):</b> Save to Library</p>
            <button class="btn" onclick="showScene('main')">BACK TO MENU</button>
        </div>
    </div>

    <div id="ui-settings" class="overlay hidden">
        <div class="scroll-pane">
            <h3>AUDIO MIXER</h3>
            <div id="mixer-container"></div>
            <hr>
            <label><input type="checkbox" id="invert-left"> INVERT LEFT HAND MAPPING</label>
        </div>
        <button class="btn" onclick="showScene('main')">SAVE & EXIT</button>
    </div>

    <div id="ui-library" class="overlay hidden">
        <div class="scroll-pane">
            <h3>SAVED TUNES (VLC PLAYER)</h3>
            <div id="library-list"></div>
        </div>
        <button class="btn" onclick="showScene('main')">BACK TO MENU</button>
    </div>

    <div id="dashboard" class="hidden">
        <div>HANDS: <span id="stat-hands">0</span></div>
        <div>ACTIVE: <span id="stat-fingers">0</span></div>
    </div>
    <div id="mode-indicator" class="hidden">MODE: PERFORM</div>

    <div id="countdown-box" class="hidden">
        <div id="timer-msg">STARTING</div>
        <div id="timer-val">3</div>
    </div>

    <canvas id="output_canvas"></canvas>
    <video id="input_video" style="display:none" playsinline></video>

<script>
let synth, recording = [], currentMode = 'PERFORM', library = [], isPerforming = false;
let rClenchTime = 0, lClenchTime = 0, bothClenchTime = 0, prayerTime = 0, startTime = 0;
const notes = ['C3','D3','E3','F3','G3','A3','B3','C4','D4','E4','F4','G4','A4','B4','C5'];
let fingerStates = {}, pulses = [];

async function enterPlay() {
    await Tone.start();
    synth = new Tone.PolySynth(Tone.Synth).toDestination();
    document.getElementById('ui-main').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    document.getElementById('mode-indicator').classList.remove('hidden');
    isPerforming = true;
    startCamera();
}

function showScene(scene) {
    document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
    document.getElementById(`ui-${scene}`).classList.remove('hidden');
    if(scene === 'library') renderLibrary();
}

// Generate Mixer
const mixer = document.getElementById('mixer-container');
['L-Thumb','L-Index','L-Mid','L-Ring','L-Pinky','R-Thumb','R-Index','R-Mid','R-Ring','R-Pinky'].forEach((f, i) => {
    mixer.innerHTML += `<div class="slider-row"><span>${f}</span><input type="range" min="0" max="1" step="0.1" value="0.7"><button onclick="synth.triggerAttackRelease('${notes[i]}','8n')">TEST</button></div>`;
});

function getStrictFist(lm) {
    const wrist = lm[0];
    const fingers = [8, 12, 16]; // Index, Mid, Ring
    let distSum = 0;
    fingers.forEach(id => distSum += Math.hypot(lm[id].x - wrist.x, lm[id].y - wrist.y));
    const pinkyDist = Math.hypot(lm[20].x - wrist.x, lm[20].y - wrist.y);
    return { isClenched: (distSum/3) < 0.14, pinkyOut: pinkyDist > 0.22 };
}

function onResults(results) {
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    let rFist = false, lFist = false, handData = [], totalFingers = 0;

    // Pulse Animation
    pulses.forEach((p, i) => {
        p.r += 4; p.a -= 0.03;
        canvasCtx.strokeStyle = `rgba(0, 242, 255, ${p.a})`;
        canvasCtx.beginPath(); canvasCtx.arc(p.x, p.y, p.r, 0, Math.PI*2); canvasCtx.stroke();
        if(p.a <= 0) pulses.splice(i, 1);
    });

    if (results.multiHandLandmarks) {
        document.getElementById('stat-hands').innerText = results.multiHandLandmarks.length;
        results.multiHandLandmarks.forEach((lm, i) => {
            const side = results.multiHandedness[i].label === "Left" ? "Right" : "Left";
            const fist = getStrictFist(lm);
            if(fist.isClenched && !fist.pinkyOut) {
                if(side === "Right") rFist = true; else lFist = true;
            }
            handData.push({lm, side});

            [4, 8, 12, 16, 20].forEach(id => {
                const tip = lm[id];
                const isBent = tip.y > lm[id-1].y;
                const x = (1-tip.x) * canvasElement.width;
                const y = tip.y * canvasElement.height;
                if(isBent) totalFingers++;

                if(isBent && !fingerStates[`${side}_${id}`] && isPerforming && (currentMode==='PERFORM' || currentMode==='RECORDING')) {
                    const noteIdx = Math.floor((1-tip.x)*(notes.length-1));
                    synth.triggerAttackRelease(notes[noteIdx], "4n");
                    pulses.push({x, y, r: 10, a: 1.0});
                    if(currentMode==='RECORDING') recording.push({note: notes[noteIdx], time: Date.now() - startTime});
                    fingerStates[`${side}_${id}`] = true;
                } else if(!isBent) fingerStates[`${side}_${id}`] = false;
                
                canvasCtx.fillStyle = isBent ? "var(--gold)" : "white";
                canvasCtx.beginPath(); canvasCtx.arc(x, y, 8, 0, Math.PI*2); canvasCtx.fill();
            });
        });
    }
    document.getElementById('stat-fingers').innerText = totalFingers;

    // --- LOGIC STATES ---
    const now = Date.now();
    const timerBox = document.getElementById('countdown-box');
    const tVal = document.getElementById('timer-val');
    const tMsg = document.getElementById('timer-msg');

    if (rFist && !lFist) {
        if(!rClenchTime) rClenchTime = now;
        let elap = Math.floor((now-rClenchTime)/1000);
        timerBox.classList.remove('hidden'); tVal.innerText = 3-elap;
        tMsg.innerText = currentMode==='RECORDING' ? "STOPPING" : "RECORDING";
        tVal.style.color = currentMode==='RECORDING' ? "var(--stop)" : "var(--rec)";
        if(elap >= 3) {
            currentMode = (currentMode==='RECORDING') ? 'STOP' : 'RECORDING';
            if(currentMode==='RECORDING') { recording = []; startTime = now; }
            rClenchTime = now + 5000; timerBox.classList.add('hidden');
        }
    } else if (lFist && !rFist && currentMode === 'STOP') {
        if(!lClenchTime) lClenchTime = now;
        let elap = Math.floor((now-lClenchTime)/1000);
        timerBox.classList.remove('hidden'); tVal.innerText = 3-elap;
        tMsg.innerText = "PLAYING"; tVal.style.color = "var(--play)";
        if(elap >= 3) {
            currentMode = 'PLAY'; timerBox.classList.add('hidden');
            recording.forEach(e => setTimeout(()=>synth.triggerAttackRelease(e.note,"4n"), e.time));
            setTimeout(()=>currentMode='STOP', recording[recording.length-1].time + 1000);
            lClenchTime = now + 5000;
        }
    } else if (rFist && lFist && currentMode === 'STOP') {
        if(!bothClenchTime) bothClenchTime = now;
        let elap = Math.floor((now-bothClenchTime)/1000);
        timerBox.classList.remove('hidden'); tVal.innerText = 5-elap;
        tMsg.innerText = "RESETTING"; tVal.style.color = "var(--new)";
        if(elap >= 5) { recording = []; currentMode = 'PERFORM'; bothClenchTime = now+5000; tVal.innerText="NEW"; }
    } else if (handData.length === 2 && Math.hypot(handData[0].lm[9].x - handData[1].lm[9].x, handData[0].lm[9].y - handData[1].lm[9].y) < 0.1) {
        if(!prayerTime) prayerTime = now;
        let elap = Math.floor((now-prayerTime)/1000);
        timerBox.classList.remove('hidden'); tVal.innerText = 3-elap;
        tMsg.innerText = "SAVING"; tVal.style.color = "var(--neon)";
        if(elap >= 3) { library.push({id: Date.now(), data: [...recording]}); prayerTime = now+5000; tVal.innerText="SAVED"; }
    } else {
        rClenchTime = lClenchTime = bothClenchTime = prayerTime = 0;
        timerBox.classList.add('hidden');
    }
    document.getElementById('mode-indicator').innerText = `MODE: ${currentMode}`;
    canvasCtx.restore();
}

function renderLibrary() {
    const list = document.getElementById('library-list');
    list.innerHTML = library.length === 0 ? "<p>No saved tunes yet.</p>" : "";
    library.forEach((item, i) => {
        list.innerHTML += `<div style="display:flex; justify-content:space-between; margin:10px; border:1px solid #444; padding:10px;">
            <span>Tune #${i+1} (${item.data.length} notes)</span>
            <button class="btn" onclick="playSaved(${i})">PLAY VLC</button>
        </div>`;
    });
}

function playSaved(idx) {
    const tune = library[idx].data;
    tune.forEach(e => setTimeout(() => synth.triggerAttackRelease(e.note, "4n"), e.time));
}

const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.8 });
hands.onResults(onResults);
const videoElement = document.getElementById('input_video');
const canvasElement = document.getElementById('output_canvas');
const canvasCtx = canvasElement.getContext('2d');

function startCamera() {
    new Camera(videoElement, {
        onFrame: async () => {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            await hands.send({image: videoElement});
        }, width: 1280, height: 720
    }).start();
}
</script>
</body>
</html>
