<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Air Piano Pro | Ultimate Stage</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root { --neon: #00f2ff; --rec: #ff3333; --play: #00ff88; --new: #bf00ff; --stop: #ffa500; }
        body { margin: 0; background: #000; color: white; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { width: 100vw; height: 100vh; position: absolute; z-index: 5; }
        
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #1a1a2e 0%, #000 100%); z-index: 1000; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden { opacity: 0 !important; pointer-events: none; visibility: hidden; }
        
        .btn { padding: 14px 30px; border: 2px solid var(--neon); background: transparent; color: var(--neon); cursor: pointer; border-radius: 8px; font-weight: bold; margin: 10px; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; }
        .btn:hover { background: var(--neon); color: black; box-shadow: 0 0 30px var(--neon); transform: translateY(-2px); }
        .btn-play { background: var(--play); border-color: var(--play); color: black; font-size: 1.4rem; padding: 20px 50px; }
        
        #hud-top { position: absolute; top: 0; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 25px; box-sizing: border-box; z-index: 500; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); border-bottom: 1px solid rgba(255,255,255,0.1); }
        #side-dash { position: absolute; top: 120px; left: 25px; width: 240px; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); border-left: 4px solid var(--neon); padding: 20px; z-index: 500; border-radius: 0 10px 10px 0; }

        #countdown-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; text-align: center; }
        #timer-val { font-size: 7rem; font-weight: 900; margin-top: -160px; text-shadow: 0 0 20px rgba(255,255,255,0.5); }
        
        .progress-ring { width: 260px; height: 260px; transform: rotate(-90deg); filter: drop-shadow(0 0 15px var(--play)); }
        .progress-ring circle { fill: none; stroke-width: 12; stroke-linecap: round; stroke: var(--play); stroke-dasharray: 628; stroke-dashoffset: 628; transition: stroke-dashoffset 0.1s linear; }

        .pane { background: #0a0a0a; padding: 40px; border-radius: 15px; width: 85%; max-height: 75%; overflow-y: auto; border: 1px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .row { display: flex; align-items: center; justify-content: space-between; margin: 15px 0; border-bottom: 1px solid #222; padding-bottom: 15px; }
        .key-scroll { height: 110px; overflow-y: auto; border: 1px solid #444; padding: 8px; background: #000; border-radius: 6px; width: 140px; }
        
        #manual-overlay { position: absolute; bottom: 30px; right: 30px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; font-size: 0.8rem; border: 1px solid #444; z-index: 500; }
    </style>
</head>
<body>

    <div id="menu-main" class="ui-layer">
        <h1 style="font-size: 4rem; letter-spacing: 20px; margin-bottom: 5px; text-align: center;">AIR PIANO <span style="color:var(--neon)">PRO</span></h1>
        <p style="color: #888; margin-bottom: 50px; letter-spacing: 3px;">PRECISION GESTURE SYNTHESIZER</p>
        <button class="btn btn-play" onclick="launchPerformance()">Enter Stage</button>
        <div style="display:flex; gap:15px; margin-top: 20px;">
            <button class="btn" onclick="showPane('settings')">Mixer & Setup</button>
            <button class="btn" onclick="showPane('library')">My Library</button>
        </div>
    </div>

    <div id="menu-settings" class="ui-layer hidden">
        <div class="pane">
            <h2 style="color:var(--neon)">STUDIO MIXER</h2>
            <div style="margin-bottom: 30px; background: #111; padding: 20px; border-radius: 8px; display: flex; align-items: center; gap: 20px;">
                <label>LEFT-HAND MODE</label>
                <input type="checkbox" id="leftHandMode" style="width:20px; height:20px;" onchange="isLeftMode = this.checked">
            </div>
            <div id="mixer-content"></div>
        </div>
        <button class="btn" onclick="showPane('main')">Apply & Exit</button>
    </div>

    <div id="menu-library" class="ui-layer hidden">
        <div class="pane">
            <h2 style="color:var(--play)">SAVED SESSIONS</h2>
            <div id="library-content"></div>
        </div>
        <button class="btn" onclick="showPane('main')">Return Home</button>
    </div>

    <div id="hud-top" class="hidden">
        <button class="btn" style="margin:0; padding: 8px 20px; border-color: #ff3333; color:#ff3333;" onclick="backToMenu()">QUIT STAGE</button>
        <div style="display: flex; gap: 30px; align-items: center;">
            <div id="rec-timer" style="color: var(--rec); font-family: 'Courier New', monospace; font-size: 1.8rem; font-weight: bold; text-shadow: 0 0 10px var(--rec);">00:00</div>
            <div id="mode-pill" style="border: 2px solid var(--neon); padding: 8px 25px; color: var(--neon); font-weight: bold; border-radius: 50px; background: rgba(0,242,255,0.1);">PERFORM</div>
        </div>
    </div>

    <div id="side-dash" class="hidden">
        <div style="color: var(--neon); font-size: 0.7rem; margin-bottom: 15px; opacity: 0.6;">MIDI STREAM</div>
        <div id="live-notes" style="font-size: 1.1rem; min-height: 100px;">Waiting for motion...</div>
    </div>

    <div id="manual-overlay" class="hidden">
        <b>GESTURE KEYS:</b><br>
        ‚úä Right Fist: REC / STOP<br>
        üñê Both Hands Open: SAVE (5s)<br>
        ü§õ Left Fist: PLAY RECORDING<br>
        ü§ú Both Fists: RESET (5s)
    </div>

    <div id="countdown-box" class="hidden">
        <svg class="progress-ring" viewBox="0 0 210 210">
            <circle id="ring-circle" cx="105" cy="105" r="100"></circle>
        </svg>
        <div id="timer-msg" style="letter-spacing: 4px; font-weight: bold;">STATUS</div>
        <div id="timer-val"></div>
    </div>

    <canvas id="output_canvas"></canvas>
    <video id="input_video" style="display:none" playsinline></video>

<script>
let synth, recording = [], library = [], isLive = false, currentMode = 'PERFORM', isLeftMode = false;
let rFistStart = 0, lFistStart = 0, bothFistStart = 0, bothOpenStart = 0, startTime = 0;
let playbackTimeouts = [];
const notes = ['C3','D3','E3','F3','G3','A3','B3','C4','D4','E4','F4','G4','A4','B4','C5'];
let fingerVols = Array(10).fill(-6), fingerNotes = [...notes.slice(0,10)];
let fingerStates = {}, ripples = [];

const canvas = document.getElementById('output_canvas');
const ctx = canvas.getContext('2d');
const video = document.getElementById('input_video');

async function ensureAudio() {
    if (!synth) {
        await Tone.start();
        synth = new Tone.PolySynth(Tone.Synth).toDestination();
    }
}

async function launchPerformance() {
    await ensureAudio();
    document.getElementById('menu-main').classList.add('hidden');
    document.querySelectorAll('#hud-top, #side-dash, #manual-overlay').forEach(el => el.classList.remove('hidden'));
    isLive = true; startCamera();
}

function showPane(pane) {
    document.querySelectorAll('.ui-layer').forEach(l => l.classList.add('hidden'));
    document.getElementById(`menu-${pane}`).classList.remove('hidden');
    if(pane === 'library') renderLibrary();
}

function backToMenu() { location.reload(); }

const mixer = document.getElementById('mixer-content');
['L-Pinky','L-Ring','L-Mid','L-Index','L-Thumb','R-Thumb','R-Index','R-Mid','R-Ring','R-Pinky'].forEach((name, i) => {
    mixer.innerHTML += `<div class="row"><span>${name}</span><input type="range" min="-30" max="0" value="-6" onchange="fingerVols[${i}]=this.value"><div class="key-scroll">${notes.map(n => `<div class="key-option ${n==fingerNotes[i]?'selected':''}" onclick="updateFingerNote(${idx = i},'${n}',this)">${n}</div>`).join('')}</div><button class="btn" style="padding:8px" onclick="testNote(${i})">üîä</button></div>`;
});

async function updateFingerNote(idx, note, el) {
    await ensureAudio();
    fingerNotes[idx] = note;
    el.parentNode.querySelectorAll('.key-option').forEach(opt => opt.classList.remove('selected'));
    el.classList.add('selected');
    testNote(idx);
}

async function testNote(i) { 
    await ensureAudio();
    synth.triggerAttackRelease(fingerNotes[i], "8n", undefined, Tone.dbToGain(fingerVols[i])); 
}

function isClenched(lm) { return Math.hypot(lm[8].x - lm[0].x, lm[8].y - lm[0].y) < 0.14; }

function onResults(results) {
    if(!isLive) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    ripples.forEach((r, i) => {
        r.rad += 4; r.alpha -= 0.02;
        ctx.strokeStyle = `hsla(${r.hue}, 100%, 70%, ${r.alpha})`;
        ctx.lineWidth = 4; ctx.beginPath(); ctx.arc(r.x, r.y, r.rad, 0, Math.PI*2); ctx.stroke();
        if(r.alpha <= 0) ripples.splice(i, 1);
    });

    let rf = false, lf = false, bo = false, bf = false, liveHTML = "", anyFist = false;

    if (results.multiHandLandmarks) {
        results.multiHandLandmarks.forEach((lm, i) => {
            let side = results.multiHandedness[i].label === "Left" ? "Right" : "Left";
            const clench = isClenched(lm);
            if(clench) anyFist = true;
            const open = Math.hypot(lm[8].x - lm[0].x, lm[8].y - lm[0].y) > 0.45;
            if(clench) { if(side === "Right") rf = true; else lf = true; }
            if(open) bo = true;

            [4, 8, 12, 16, 20].forEach((id, fIdx) => {
                const tip = lm[id];
                const x = (1-tip.x) * canvas.width, y = tip.y * canvas.height;
                const isBent = tip.y > lm[id-1].y;
                if(isBent && !anyFist && (currentMode==='PERFORM' || currentMode==='RECORDING')) {
                    const noteIdx = Math.floor((1-tip.x) * (notes.length-1));
                    const note = notes[noteIdx];
                    liveHTML += `<div style="color:var(--neon)">${side} ‚Üí ${note}</div>`;
                    if(!fingerStates[`${side}_${id}`]) {
                        synth.triggerAttackRelease(note, "4n", undefined, Tone.dbToGain(fingerVols[fIdx + (side==='Right'?5:0)]));
                        ripples.push({x, y, rad: 5, alpha: 1.0, hue: noteIdx*24});
                        if(currentMode === 'RECORDING') recording.push({note, time: Date.now()-startTime});
                        fingerStates[`${side}_${id}`] = true;
                    }
                } else { fingerStates[`${side}_${id}`] = false; }
                ctx.fillStyle = isBent ? "var(--play)" : "white";
                ctx.beginPath(); ctx.arc(x, y, 8, 0, Math.PI*2); ctx.fill();
            });
        });
        if(rf && lf) bf = true;
    }

    const now = Date.now(), box = document.getElementById('countdown-box'), val = document.getElementById('timer-val'), msg = document.getElementById('timer-msg'), circle = document.getElementById('ring-circle');
    let recHand = isLeftMode ? lf : rf, playHand = isLeftMode ? rf : lf;

    if(currentMode === 'RECORDING') {
        let s = Math.floor((now-startTime)/1000);
        document.getElementById('rec-timer').innerText = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
    }

    if(recHand && !playHand && currentMode !== 'PLAYING') {
        if(!rFistStart) rFistStart = now;
        let elap = Math.floor((now-rFistStart)/1000);
        box.classList.remove('hidden'); circle.parentElement.style.display="none";
        val.innerText = 3-elap; msg.innerText = currentMode==='RECORDING' ? "STOPPING..." : "RECORDING...";
        if(elap >= 3) {
            currentMode = currentMode==='RECORDING'?'STOP':'RECORDING';
            if(currentMode==='RECORDING') { recording=[]; startTime=now; }
            rFistStart=now+2000; box.classList.add('hidden');
        }
    } else if(playHand && !recHand && currentMode==='STOP' && recording.length > 0) {
        if(!lFistStart) lFistStart = now;
        box.classList.remove('hidden'); circle.parentElement.style.display="none";
        val.innerText = 3-Math.floor((now-lFistStart)/1000); msg.innerText = "STARTING...";
        if(now-lFistStart >= 3000) {
            currentMode='PLAYING'; val.innerText = ""; msg.innerText = "PLAYING";
            circle.parentElement.style.display="block";
            let total = recording[recording.length-1].time;
            recording.forEach(e => {
                let t = setTimeout(() => {
                    synth.triggerAttackRelease(e.note,"4n");
                    circle.style.strokeDashoffset = 628 - (e.time/total * 628);
                }, e.time);
                playbackTimeouts.push(t);
            });
            setTimeout(() => { currentMode='STOP'; box.classList.add('hidden'); circle.style.strokeDashoffset = 628; }, total + 500);
            lFistStart=now+2000;
        }
    } else if(bf) { 
        if(!bothFistStart) bothFistStart = now;
        box.classList.remove('hidden'); val.innerText = 5-Math.floor((now-bothFistStart)/1000);
        msg.innerText = "RESETTING SESSION";
        if(now-bothFistStart >= 5000) { recording=[]; currentMode='PERFORM'; bothFistStart=now+2000; box.classList.add('hidden'); }
    } else if(bo && currentMode==='STOP' && recording.length > 0) { 
        if(!bothOpenStart) bothOpenStart = now;
        box.classList.remove('hidden'); val.innerText = 5-Math.floor((now-bothOpenStart)/1000);
        msg.innerText = "SAVING...";
        if(now-bothOpenStart >= 5000) { 
            library.push({name: "Performance_"+new Date().toLocaleTimeString(), data: [...recording]}); 
            bothOpenStart=now+2000; val.innerText="SAVED"; 
            setTimeout(()=> { box.classList.add('hidden'); renderLibrary(); }, 1000); 
        }
    } else if(currentMode !== 'PLAYING') {
        rFistStart = lFistStart = bothFistStart = bothOpenStart = 0;
        box.classList.add('hidden');
    }
}

function renderLibrary() {
    const lib = document.getElementById('library-content');
    if(library.length === 0) { lib.innerHTML = "<p>No recordings yet. Save one in the Stage!</p>"; return; }
    lib.innerHTML = library.map((t, i) => `
        <div class="row">
            <span>${t.name}</span>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="padding:8px" onclick="playLib(${i})">PLAY</button>
                <button class="btn" style="padding:8px; border-color:var(--play); color:var(--play);" onclick="shareSession(${i})">SHARE</button>
                <button class="btn" style="padding:8px; border-color:white; color:white;" onclick="downloadSession(${i})">DOWNLOAD</button>
            </div>
        </div>`).join('');
}

function playLib(i) { 
    ensureAudio();
    library[i].data.forEach(e => setTimeout(() => synth.triggerAttackRelease(e.note, "4n"), e.time)); 
}

function downloadSession(i) {
    const blob = new Blob([JSON.stringify(library[i].data)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `${library[i].name}.json`; a.click();
}

async function shareSession(i) {
    const shareData = {
        title: 'Air Piano Pro Session',
        text: `Check out my Air Piano performance: ${library[i].name}`,
        url: window.location.href
    };
    try {
        await navigator.share(shareData);
    } catch (err) {
        alert("Sharing link copied to clipboard!");
        navigator.clipboard.writeText(window.location.href);
    }
}

const handTracker = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
handTracker.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.8 });
handTracker.onResults(onResults);
function startCamera() { new Camera(video, { onFrame: async () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; await handTracker.send({image: video}); }, width: 1280, height: 720 }).start(); }
</script>
</body>
</html>
