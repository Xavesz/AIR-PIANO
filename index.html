<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Air Piano Pro | Ultimate Edition</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root { --neon: #00f2ff; --rec: #ff3333; --play: #00ff88; --new: #bf00ff; --stop: #ffa500; --gold: #ffd700; }
        body { margin: 0; background: #000; color: white; overflow: hidden; font-family: 'Orbitron', sans-serif; }
        canvas { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; }
        
        /* UI Layers */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); z-index: 1000; text-align: center; }
        .hidden { display: none !important; }
        
        .btn { padding: 15px 40px; border: 2px solid var(--neon); background: transparent; color: var(--neon); cursor: pointer; border-radius: 5px; font-weight: bold; text-transform: uppercase; margin: 10px; transition: 0.3s; }
        .btn:hover { background: var(--neon); color: black; box-shadow: 0 0 20px var(--neon); }
        
        /* HUD & Stats */
        #dashboard { position: absolute; top: 20px; left: 20px; border-left: 4px solid var(--neon); padding: 10px; background: rgba(255,255,255,0.05); z-index: 500; }
        #mode-pill { position: absolute; top: 20px; right: 20px; padding: 10px 20px; border-radius: 5px; font-weight: bold; border: 1px solid var(--neon); z-index: 500; }

        /* Countdown */
        #countdown-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 800; pointer-events: none; }
        #timer-val { font-size: 9rem; font-weight: bold; }
        #timer-msg { font-size: 1.5rem; letter-spacing: 5px; }

        /* Settings & Library */
        .scroll-pane { background: #111; padding: 30px; border-radius: 10px; width: 80%; max-height: 70%; overflow-y: auto; border: 1px solid #333; }
        .slider-row { display: flex; align-items: center; gap: 20px; margin: 15px 0; }
        input[type=range] { flex-grow: 1; accent-color: var(--neon); }
    </style>
</head>
<body>

    <div id="ui-main" class="overlay">
        <h1 style="font-size: 3rem; color: var(--neon);">AIR PIANO <span style="color:white">PRO</span></h1>
        <button class="btn" onclick="startCalibration()">1. CALIBRATE HANDS</button>
        <button class="btn" onclick="showPane('settings')">2. AUDIO MIXER</button>
        <button class="btn" onclick="showPane('library')">3. SAVED TUNES</button>
        <button class="btn" onclick="enterPerformance()" style="background: var(--play); color: black;">ðŸš€ LAUNCH PLAY</button>
    </div>

    <div id="ui-calibration" class="overlay hidden">
        <h2 id="calib-step">LEFT HAND: THUMB</h2>
        <p>Bend the specific finger highlighted</p>
        <button class="btn" onclick="exitToMenu()">BACK TO MENU</button>
    </div>

    <div id="ui-settings" class="overlay hidden">
        <div class="scroll-pane">
            <h3>FINGER AUDIO MIXER</h3>
            <div id="mixer-container"></div>
            <hr>
            <label><input type="checkbox" id="invert-left"> INVERT LEFT HAND MAPPING</label>
        </div>
        <button class="btn" onclick="exitToMenu()">SAVE & EXIT</button>
    </div>

    <div id="ui-library" class="overlay hidden">
        <div class="scroll-pane" id="library-list">
            <h3>SAVED RECORDINGS</h3>
            </div>
        <button class="btn" onclick="exitToMenu()">BACK TO MENU</button>
    </div>

    <div id="dashboard" class="hidden">
        <div>HANDS: <span id="stat-hands">0</span></div>
        <div>ACTIVE: <span id="stat-fingers">0</span></div>
    </div>
    <div id="mode-pill" class="hidden">MODE: PERFORM</div>

    <div id="countdown-box" class="hidden">
        <div id="timer-msg">STARTING</div>
        <div id="timer-val">3</div>
    </div>

    <canvas id="output_canvas"></canvas>
    <video id="input_video" style="display:none" playsinline></video>

<script>
let synth, recording = [], currentMode = 'PERFORM', library = [], isPerforming = false;
let rClenchTime = 0, lClenchTime = 0, bothClenchTime = 0, prayerTime = 0;
let calibIndex = 0;
const calibOrder = ['L-Thumb','L-Index','L-Mid','L-Ring','L-Pinky','R-Thumb','R-Index','R-Mid','R-Ring','R-Pinky'];

const video = document.getElementById('input_video');
const canvas = document.getElementById('output_canvas');
const ctx = canvas.getContext('2d');
const notes = ['C3','D3','E3','F3','G3','A3','B3','C4','D4','E4','F4','G4','A4','B4','C5'];
let fingerStates = {}, drops = [];

// --- BOOT ---
async function enterPerformance() {
    await Tone.start();
    synth = new Tone.PolySynth(Tone.Synth).toDestination();
    document.getElementById('ui-main').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    document.getElementById('mode-pill').classList.remove('hidden');
    isPerforming = true;
    startCamera();
}

function showPane(pane) {
    document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
    document.getElementById(`ui-${pane}`).classList.remove('hidden');
}

function exitToMenu() {
    isPerforming = false;
    showPane('main');
}

// --- MIXER ---
const mixer = document.getElementById('mixer-container');
calibOrder.forEach((name, i) => {
    mixer.innerHTML += `<div class="slider-row"><span>${name}</span><input type="range" min="0" max="1" step="0.1" value="0.7"><button onclick="synth.triggerAttackRelease('${notes[i]}','8n')">TEST</button></div>`;
});

// --- GESTURE LOGIC ---
function getFistData(lm) {
    const wrist = lm[0];
    const fingers = [8, 12, 16]; // Index, Mid, Ring
    let distSum = 0;
    fingers.forEach(id => distSum += Math.hypot(lm[id].x - wrist.x, lm[id].y - wrist.y));
    const pinkyDist = Math.hypot(lm[20].x - wrist.x, lm[20].y - wrist.y);
    // Strict Fist: Center fingers in, but pinky can be out to play notes
    return { isClenched: (distSum/3) < 0.15, pinkySafe: pinkyDist > 0.2 };
}

function onResults(results) {
    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let rFist = false, lFist = false, activeFingers = 0;

    // Raindrop Animation
    drops.forEach((d, i) => {
        d.y += 5; d.alpha -= 0.02;
        ctx.fillStyle = `rgba(0, 242, 255, ${d.alpha})`;
        ctx.fillText(d.note, d.x, d.y);
        if(d.alpha <= 0) drops.splice(i, 1);
    });

    if (results.multiHandLandmarks) {
        document.getElementById('stat-hands').innerText = results.multiHandLandmarks.length;
        results.multiHandLandmarks.forEach((lm, hIdx) => {
            let side = results.multiHandedness[hIdx].label === "Left" ? "Right" : "Left";
            const fist = getFistData(lm);
            
            if(fist.isClenched && !fist.pinkySafe) {
                if(side === "Right") rFist = true; else lFist = true;
            }

            // Piano Play
            [4, 8, 12, 16, 20].forEach((id, fIdx) => {
                const tip = lm[id];
                const isBent = tip.y > lm[id-1].y;
                if(isBent) activeFingers++;
                
                if(isBent && !fingerStates[`${side}_${id}`] && isPerforming && (currentMode==='PERFORM' || currentMode==='RECORDING')) {
                    const x = (1-tip.x) * canvas.width;
                    const n = notes[Math.floor((1-tip.x)*(notes.length-1))];
                    synth.triggerAttackRelease(n, "4n");
                    drops.push({x, y: tip.y * canvas.height, note: n, alpha: 1.0});
                    if(currentMode === 'RECORDING') recording.push({note: n, time: Date.now() - startTime});
                    fingerStates[`${side}_${id}`] = true;
                } else if(!isBent) fingerStates[`${side}_${id}`] = false;

                // Visual dots
                ctx.fillStyle = isBent ? "var(--gold)" : "white";
                ctx.beginPath(); ctx.arc((1-tip.x)*canvas.width, tip.y*canvas.height, 8, 0, Math.PI*2); ctx.fill();
            });
        });
    }
    document.getElementById('stat-fingers').innerText = activeFingers;

    // COUNTDOWN & STATE LOGIC
    const now = Date.now();
    const timerBox = document.getElementById('countdown-box');
    const timerVal = document.getElementById('timer-val');
    const timerMsg = document.getElementById('timer-msg');

    if(rFist && !lFist) {
        if(!rFistStart) rFistStart = now;
        let elap = Math.floor((now-rFistStart)/1000);
        timerBox.classList.remove('hidden');
        timerVal.innerText = 3 - elap;
        timerMsg.innerText = currentMode === 'RECORDING' ? "STOPPING" : "RECORDING";
        timerVal.style.color = currentMode === 'RECORDING' ? "var(--stop)" : "var(--rec)";
        if(elap >= 3) { 
            currentMode = currentMode === 'RECORDING' ? 'STOP' : 'RECORDING';
            if(currentMode === 'RECORDING') { recording = []; startTime = now; }
            rFistStart = now + 5000; timerBox.classList.add('hidden');
        }
    } else if (lFist && !rFist && currentMode === 'STOP') {
        if(!lClenchTime) lClenchTime = now;
        timerBox.classList.remove('hidden');
        timerVal.innerText = 3 - Math.floor((now-lClenchTime)/1000);
        timerMsg.innerText = "PLAYING"; timerVal.style.color = "var(--play)";
        if(now - lClenchTime >= 3000) {
            currentMode = 'PLAY'; timerBox.classList.add('hidden');
            recording.forEach(e => setTimeout(() => synth.triggerAttackRelease(e.note, "4n"), e.time));
            setTimeout(() => currentMode = 'STOP', recording[recording.length-1].time + 1000);
            lClenchTime = now + 5000;
        }
    } else {
        rFistStart = 0; lClenchTime = 0;
        timerBox.classList.add('hidden');
    }
    document.getElementById('mode-pill').innerText = `MODE: ${currentMode}`;
    ctx.restore();
}

const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.8 });
hands.onResults(onResults);

function startCamera() {
    new Camera(video, {
        onFrame: async () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            await hands.send({image: video});
        }, width: 1280, height: 720
    }).start();
}
</script>
</body>
</html>
