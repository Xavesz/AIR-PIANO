<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Air Piano Pro | Ultimate Stage</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root { --neon: #00f2ff; --rec: #ff3333; --play: #00ff88; --new: #bf00ff; --stop: #ffa500; }
        body { margin: 0; background: #000; color: white; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { width: 100vw; height: 100vh; position: absolute; z-index: 5; }
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(5,5,10,0.98); z-index: 1000; transition: all 0.4s ease; }
        .hidden { opacity: 0; pointer-events: none; display: none !important; }
        .btn { padding: 12px 25px; border: 2px solid var(--neon); background: transparent; color: var(--neon); cursor: pointer; border-radius: 4px; font-weight: bold; margin: 10px; text-transform: uppercase; }
        .btn:hover { background: var(--neon); color: black; }
        #hud-top { position: absolute; top: 0; width: 100%; display: flex; justify-content: space-between; padding: 20px; box-sizing: border-box; z-index: 500; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        
        /* Central HUD for Play/Pause/Progress */
        #status-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 900; text-align: center; pointer-events: none; display: flex; flex-direction: column; align-items: center; }
        .progress-ring { width: 180px; height: 180px; transform: rotate(-90deg); }
        .progress-ring circle { fill: transparent; stroke-width: 10; stroke-dasharray: 565; stroke-dashoffset: 565; stroke-linecap: round; transition: stroke-dashoffset 0.1s linear; }
        #timer-msg { font-size: 1.5rem; letter-spacing: 3px; margin-top: 15px; font-weight: bold; }
        #icon-box { font-size: 4rem; position: absolute; top: 60px; }

        .key-scroll { height: 80px; overflow-y: scroll; border: 1px solid #444; background: #000; width: 100px; }
        .row { display: flex; align-items: center; justify-content: space-between; margin: 10px 0; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .pane { background: #111; padding: 25px; border-radius: 8px; width: 80%; max-height: 70%; overflow-y: auto; border: 1px solid #333; }
    </style>
</head>
<body>

    <div id="menu-main" class="ui-layer">
        <h1 style="font-size: 3rem; letter-spacing: 10px;">AIR PIANO <span style="color:var(--neon)">PRO</span></h1>
        <button class="btn" style="background:var(--play); color:black;" onclick="launchPerformance()">Launch Stage</button>
        <button class="btn" onclick="showPane('settings')">Settings</button>
    </div>

    <div id="menu-settings" class="ui-layer hidden">
        <div class="pane">
            <h3>MIXER & KEY BINDINGS</h3>
            <div style="background:#222; padding:10px; margin-bottom:15px;">
                <label>LEFT HAND MODE: </label><input type="checkbox" id="lhm" onchange="isLeftMode = this.checked">
            </div>
            <div id="mixer-content"></div>
        </div>
        <button class="btn" onclick="showPane('main')">Save</button>
    </div>

    <div id="hud-top" class="hidden">
        <button class="btn" onclick="backToMenu()">EXIT</button>
        <div id="mode-pill" style="border:1px solid var(--neon); padding:5px 15px; color:var(--neon);">READY</div>
    </div>

    <div id="status-container" class="hidden">
        <svg class="progress-ring">
            <circle id="ring-bg" cx="90" cy="90" r="85" stroke="rgba(255,255,255,0.1)"></circle>
            <circle id="ring-bar" cx="90" cy="90" r="85" stroke="var(--play)"></circle>
        </svg>
        <div id="icon-box"></div>
        <div id="timer-msg">STATUS</div>
        <div id="live-clock" style="font-family: monospace; font-size: 2rem;">00:00</div>
    </div>

    <div id="side-dash" class="hidden" style="position:absolute; left:20px; top:100px; pointer-events:none;">
        <div id="live-notes"></div>
    </div>

    <canvas id="output_canvas"></canvas>
    <video id="input_video" style="display:none" playsinline></video>

<script>
let synth, recording = [], isLive = false, currentMode = 'PERFORM', isLeftMode = false;
let startTime = 0, playbackTimeouts = [];
let rfStart = 0, lfStart = 0, bfStart = 0;
const notes = ['C3','D3','E3','F3','G3','A3','B3','C4','D4','E4','F4','G4','A4','B4','C5'];
let fingerVols = Array(10).fill(-6), fingerNotes = [...notes.slice(0,10)], fingerStates = {};

const video = document.getElementById('input_video');
const canvas = document.getElementById('output_canvas');
const ctx = canvas.getContext('2d');

async function launchPerformance() {
    if(!synth) { await Tone.start(); synth = new Tone.PolySynth(Tone.Synth).toDestination(); }
    document.getElementById('menu-main').classList.add('hidden');
    document.getElementById('hud-top').classList.remove('hidden');
    document.getElementById('status-container').classList.remove('hidden');
    isLive = true;
    startCamera();
}

function showPane(pane) {
    document.querySelectorAll('.ui-layer').forEach(l => l.classList.add('hidden'));
    document.getElementById(`menu-${pane}`).classList.remove('hidden');
}

function backToMenu() { location.reload(); }

// Generate Mixer UI
const mixer = document.getElementById('mixer-content');
['L-P','L-R','L-M','L-I','L-T','R-T','R-I','R-M','R-R','R-P'].forEach((name, i) => {
    mixer.innerHTML += `<div class="row"><span>${name}</span>
        <div class="key-scroll">${notes.map(n=>`<div onclick="fingerNotes[${i}]='${n}'; testNote(${i})" style="padding:4px; font-size:0.8rem; cursor:pointer">${n}</div>`).join('')}</div>
        <button class="btn" style="padding:5px" onclick="testNote(${i})">ðŸ”Š</button>
    </div>`;
});
function testNote(i) { synth.triggerAttackRelease(fingerNotes[i], "8n", undefined, Tone.dbToGain(fingerVols[i])); }

function isClenched(lm) { return Math.hypot(lm[8].x - lm[0].x, lm[8].y - lm[0].y) < 0.14; }

function onResults(results) {
    if(!isLive) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    let rf = false, lf = false, bf = false, liveHTML = "";
    const now = Date.now();
    const ring = document.getElementById('ring-bar');
    const icon = document.getElementById('icon-box');
    const msg = document.getElementById('timer-msg');
    const clock = document.getElementById('live-clock');

    if (results.multiHandLandmarks) {
        results.multiHandLandmarks.forEach((lm, i) => {
            let side = results.multiHandedness[i].label === "Left" ? "Right" : "Left";
            let clench = isClenched(lm);
            if(clench) { if(side === "Right") rf = true; else lf = true; }

            // ONLY PLAY NOTES IF NOT CLENCHED (PROTECTION)
            if(!clench && (currentMode === 'PERFORM' || currentMode === 'RECORDING')) {
                [4, 8, 12, 16, 20].forEach((id, fIdx) => {
                    const tip = lm[id];
                    const isBent = tip.y > lm[id-1].y;
                    if(isBent) {
                        const note = notes[Math.floor((1-tip.x) * (notes.length-1))];
                        if(!fingerStates[`${side}_${id}`]) {
                            synth.triggerAttackRelease(note, "4n");
                            if(currentMode === 'RECORDING') recording.push({note, time: now - startTime});
                            fingerStates[`${side}_${id}`] = true;
                        }
                    } else { fingerStates[`${side}_${id}`] = false; }
                });
            }
        });
        if(rf && lf) bf = true;
    }

    // HAND GESTURE LOGIC
    let recHand = isLeftMode ? lf : rf;
    let playHand = isLeftMode ? rf : lf;

    // 1. RECORDING LOGIC
    if(recHand && !playHand && currentMode !== 'PLAYING') {
        if(!rfStart) rfStart = now;
        let elap = now - rfStart;
        ring.style.strokeDashoffset = 565 - (elap/3000)*565;
        ring.style.stroke = "var(--rec)";
        msg.innerText = currentMode === 'RECORDING' ? "STOPPING..." : "RECORDING...";
        icon.innerText = "ðŸ”´";
        if(elap >= 3000) {
            if(currentMode === 'RECORDING') { currentMode = 'STOP'; }
            else { currentMode = 'RECORDING'; recording = []; startTime = now; }
            rfStart = now + 2000;
        }
    } 
    // 2. PLAYBACK LOGIC
    else if(playHand && !recHand && currentMode === 'STOP' && recording.length > 0) {
        if(!lfStart) lfStart = now;
        let elap = now - lfStart;
        ring.style.strokeDashoffset = 565 - (elap/3000)*565;
        ring.style.stroke = "var(--play)";
        msg.innerText = "STARTING...";
        icon.innerText = "â–¶ï¸";
        if(elap >= 3000) {
            currentMode = 'PLAYING';
            let totalDur = recording[recording.length-1].time;
            recording.forEach(e => {
                let t = setTimeout(() => {
                    synth.triggerAttackRelease(e.note, "4n");
                    ring.style.strokeDashoffset = 565 - (e.time/totalDur)*565;
                }, e.time);
                playbackTimeouts.push(t);
            });
            setTimeout(() => { currentMode = 'STOP'; ring.style.strokeDashoffset = 565; }, totalDur + 500);
            lfStart = now + 2000;
        }
    }
    // 3. EMERGENCY STOP DURING PLAYBACK
    else if(recHand && currentMode === 'PLAYING') {
        playbackTimeouts.forEach(t => clearTimeout(t));
        currentMode = 'STOP';
        msg.innerText = "STOPPED";
        icon.innerText = "â¹ï¸";
        ring.style.strokeDashoffset = 565;
    }
    // 4. RESET (BOTH HANDS)
    else if(bf) {
        if(!bfStart) bfStart = now;
        if(now - bfStart > 2000) { recording = []; currentMode = 'PERFORM'; ring.style.strokeDashoffset = 565; }
    }
    else {
        rfStart = lfStart = bfStart = 0;
        if(currentMode !== 'PLAYING') {
            ring.style.strokeDashoffset = 565;
            msg.innerText = currentMode;
            icon.innerText = currentMode === 'RECORDING' ? "âºï¸" : (currentMode === 'STOP' ? "â¹ï¸" : "ðŸŽ¹");
        }
    }

    if(currentMode === 'RECORDING' || currentMode === 'PLAYING') {
        let displayTime = currentMode === 'RECORDING' ? (now - startTime) : 0; // simplified for recording
        let sec = Math.floor(displayTime/1000);
        clock.innerText = `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`;
    }

    document.getElementById('mode-pill').innerText = currentMode;
}

const handTracker = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
handTracker.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.8 });
handTracker.onResults(onResults);
function startCamera() { new Camera(video, { onFrame: async () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; await handTracker.send({image: video}); }, width: 1280, height: 720 }).start(); }
</script>
</body>
</html>
