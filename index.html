<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quantum Soul | Angelic Resonance</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root { --quantum: #bf00ff; --divine: #00f2ff; --soul: #ffaa00; --bg: #020208; }
        body { margin: 0; background: var(--bg); color: white; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { width: 100vw; height: 100vh; position: absolute; z-index: 5; }
        
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #0a0a25 0%, #000 100%); z-index: 1000; transition: 0.8s ease-in-out; }
        .hidden { opacity: 0 !important; pointer-events: none; visibility: hidden; }
        
        .btn { padding: 20px 50px; border: 1px solid var(--divine); background: transparent; color: var(--divine); cursor: pointer; border-radius: 50px; font-weight: bold; text-transform: uppercase; letter-spacing: 5px; transition: 0.4s; }
        .btn:hover { background: var(--divine); color: #000; box-shadow: 0 0 50px var(--divine); transform: scale(1.05); }

        #hud-top { position: absolute; top: 0; width: 100%; display: flex; justify-content: space-between; padding: 30px; box-sizing: border-box; z-index: 500; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); }
        
        #coherence-meter { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 300px; text-align: center; z-index: 500; }
        .meter-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 10px; overflow: hidden; }
        #meter-fill { width: 0%; height: 100%; background: var(--divine); transition: 0.3s; box-shadow: 0 0 15px var(--divine); }

        .manual-card { background: rgba(255,255,255,0.02); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); margin: 20px; max-width: 450px; backdrop-filter: blur(10px); }
        .manual-card h3 { color: var(--divine); margin-top: 0; letter-spacing: 2px; }
        .manual-card ul { padding-left: 20px; color: #ccc; }
        .manual-card li { margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="menu-main" class="ui-layer">
        <h1 style="font-size: 3.5rem; letter-spacing: 15px; margin-bottom: 10px;">QUANTUM <span style="color:var(--divine)">SOUL</span></h1>
        <div class="manual-card">
            <h3>USER MANUAL: COHERENCE STAGE</h3>
            <ul>
                <li>üñê <b>ANGELIC MODE:</b> Move fingers to trigger high-frequency physics tones.</li>
                <li>‚úä <b>RIGHT FIST:</b> Increase <b>Coherence</b>. Two waves overlap to create a massive, powerful sound.</li>
                <li>‚úä <b>LEFT FIST:</b> Lower sound intensity for delicate, ghostly textures.</li>
                <li>‚úä‚úä <b>BOTH FISTS:</b> The <b>Divine Soul State</b>. Deeply nostalgic, nostalgic quantum resonance.</li>
                <li>üñêüñê <b>OPEN BOTH:</b> Instantly return to standard Angelic Mode.</li>
            </ul>
        </div>
        <button class="btn" onclick="initQuantumStage()">INITIATE RESONANCE</button>
    </div>

    <div id="hud-top" class="hidden">
        <button class="btn" style="padding: 10px 25px; font-size: 0.6rem;" onclick="location.reload()">TERMINATE</button>
        <div style="text-align: right">
            <div id="state-text" style="color: var(--divine); font-weight: bold; letter-spacing: 3px; font-size: 1.2rem;">ANGELIC MODE</div>
            <div id="hand-count" style="font-size: 0.7rem; color: #888; margin-top: 5px;">QUANTUM COHERENCE: 0%</div>
        </div>
    </div>

    <div id="coherence-meter" class="hidden">
        <div style="font-size: 0.7rem; letter-spacing: 2px; opacity: 0.8;">RESONANCE AMPLITUDE</div>
        <div class="meter-bg"><div id="meter-fill"></div></div>
    </div>

    <canvas id="output_canvas"></canvas>
    <video id="input_video" style="display:none" playsinline></video>

<script>
let synth, lfo, filter, isLive = false;
let coherence = 0; // 0 to 1
let fingerStates = {}, ripples = [];

const canvas = document.getElementById('output_canvas');
const ctx = canvas.getContext('2d');
const video = document.getElementById('input_video');

async function initQuantumStage() {
    await Tone.start();
    
    // NOSTALGIC SOUL ENGINE (FM + ANALOG JITTER)
    filter = new Tone.LowpassCombFilter(0.1, 0.5, 3000).toDestination();
    const reverb = new Tone.Reverb({ decay: 5, wet: 0.6 }).connect(filter);
    
    synth = new Tone.PolySynth(Tone.FMSynth, {
        harmonicity: 2,
        modulationIndex: 2,
        oscillator: { type: "sine" },
        envelope: { attack: 0.4, release: 2 },
        modulation: { type: "square" }
    }).connect(reverb);

    document.getElementById('menu-main').classList.add('hidden');
    document.querySelectorAll('#hud-top, #coherence-meter').forEach(el => el.classList.remove('hidden'));
    
    isLive = true;
    startCamera();
}

function onResults(results) {
    if(!isLive) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Render Soul Ripples
    ripples.forEach((r, i) => {
        r.rad += 2.5; r.alpha -= 0.012;
        ctx.strokeStyle = `rgba(${r.r}, ${r.g}, ${r.b}, ${r.alpha})`;
        ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(r.x, r.y, r.rad, 0, Math.PI*2); ctx.stroke();
        if(r.alpha <= 0) ripples.splice(i, 1);
    });

    let rf = false, lf = false;
    let handCount = results.multiHandLandmarks ? results.multiHandLandmarks.length : 0;
    document.getElementById('hand-count').innerText = `QUANTUM COHERENCE: ${Math.round(coherence * 100)}%`;

    if (results.multiHandLandmarks) {
        results.multiHandLandmarks.forEach((lm, i) => {
            const label = results.multiHandedness[i].label; // Mirrored
            const isFist = Math.hypot(lm[8].x - lm[0].x, lm[8].y - lm[0].y) < 0.13;
            
            if(isFist) { if(label === "Left") lf = true; else rf = true; }

            // Quantum Interactions
            [8, 12, 16, 20].forEach((id, fIdx) => {
                const tip = lm[id];
                const x = (1-tip.x) * canvas.width, y = tip.y * canvas.height;
                const active = tip.y > lm[id-1].y;

                if(active && !isFist) {
                    const notes = ['C3','E3','G3','B3','C4','E4','G4','B4','D5','F5'];
                    const nIdx = Math.floor((1-tip.x) * (notes.length-1));
                    const note = notes[nIdx];

                    if(!fingerStates[`${label}_${id}`]) {
                        // Volume and Timbre scale with Coherence
                        let vol = -15 + (coherence * 10);
                        synth.triggerAttackRelease(note, "1n", undefined, Tone.dbToGain(vol));
                        
                        // Particle Color based on state
                        let color = coherence > 0.8 ? {r:255, g:170, b:0} : {r:0, g:242, b:255};
                        ripples.push({x, y, rad: 5, alpha: 0.8, ...color});
                        fingerStates[`${label}_${id}`] = true;
                    }
                } else { fingerStates[`${label}_${id}`] = false; }
                
                ctx.fillStyle = active ? (coherence > 0.8 ? "var(--soul)" : "var(--divine)") : "white";
                ctx.beginPath(); ctx.arc(x, y, 7, 0, Math.PI*2); ctx.fill();
            });
        });
    }

    // UPDATE QUANTUM STATE MACHINE
    const stateLabel = document.getElementById('state-text');
    const meterFill = document.getElementById('meter-fill');

    if(rf && lf) {
        currentMode = "DIVINE SOUL";
        coherence = Math.min(coherence + 0.01, 1.0);
        stateLabel.innerText = "DIVINE SOUL STATE";
        stateLabel.style.color = "var(--soul)";
        synth.set({ modulationIndex: 25, harmonicity: 1.01 }); // Deep Soul vibration
    } else if(rf) {
        coherence = Math.min(coherence + 0.005, 0.7);
        stateLabel.innerText = "CONSTRUCTIVE INTERFERENCE";
        stateLabel.style.color = "var(--divine)";
        synth.set({ modulationIndex: 10, harmonicity: 2 });
    } else if(lf) {
        coherence = Math.max(coherence - 0.005, 0.1);
        stateLabel.innerText = "DESTRUCTIVE INTERFERENCE";
        stateLabel.style.color = "#ff3333";
        synth.set({ modulationIndex: 1, harmonicity: 4 });
    } else {
        // Naturally decay coherence unless holding fists
        coherence = Math.max(coherence - 0.002, 0);
        if(coherence < 0.1) {
            stateLabel.innerText = "ANGELIC MODE";
            stateLabel.style.color = "var(--divine)";
            synth.set({ modulationIndex: 2, harmonicity: 2 });
        }
    }
    meterFill.style.width = (coherence * 100) + "%";
}

const handTracker = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
handTracker.setOptions({ maxNumHands: 2, modelComplexity: 0, minDetectionConfidence: 0.7 });
handTracker.onResults(onResults);

function startCamera() {
    new Camera(video, {
        onFrame: async () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            await handTracker.send({image: video});
        },
        width: 1280, height: 720
    }).start();
}
</script>
</body>
</html>
