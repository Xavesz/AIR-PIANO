<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quantum Soul | Stable Resonance</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root { --divine: #00f2ff; --soul: #ffaa00; --bg: #020205; }
        body { margin: 0; background: var(--bg); color: white; overflow: hidden; font-family: sans-serif; }
        
        /* Mirroring Fix */
        #output_canvas, #input_video { 
            transform: scaleX(-1); /* Flips camera to act like a mirror */
            width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; 
        }

        .ui-layer { position: absolute; z-index: 1000; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); transition: 0.5s; }
        .hidden { display: none !important; }
        
        .btn { padding: 15px 40px; border: 2px solid var(--divine); background: transparent; color: var(--divine); border-radius: 50px; cursor: pointer; font-weight: bold; letter-spacing: 2px; }
        
        #hud { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; z-index: 500; box-sizing: border-box; pointer-events: none; }
        .stat-box { background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 10px; border: 1px solid var(--divine); }
        
        #manual { max-width: 400px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; font-size: 0.9rem; border: 1px solid #333; }
    </style>
</head>
<body>

    <div id="menu" class="ui-layer">
        <h1 style="letter-spacing:10px">QUANTUM <span style="color:var(--divine)">SOUL</span></h1>
        <div id="manual">
            <b>STABILITY MANUAL:</b><br>
            ‚Ä¢ üñê <b>Angelic Mode:</b> Open fingers to play crystal tones.<br>
            ‚Ä¢ ‚úä <b>Right Fist:</b> Overlap waves for <b>High Coherence</b> (Loud/Powerful).<br>
            ‚Ä¢ ‚úä <b>Left Fist:</b> Destructive interference (Low/Ghostly).<br>
            ‚Ä¢ ‚úä‚úä <b>Both Fists:</b> Divine Nostalgic Soul state.<br>
            ‚Ä¢ üñêüñê <b>Reset:</b> Open both hands to return to normal.
        </div>
        <button class="btn" onclick="startApp()">START STAGE</button>
    </div>

    <div id="hud" class="hidden">
        <div class="stat-box" id="state-text">ANGELIC MODE</div>
        <div class="stat-box" id="fps-text">TRACKING...</div>
    </div>

    <canvas id="output_canvas"></canvas>
    <video id="input_video" playsinline></video>

<script>
let synth, isLive = false, coherence = 0;
let fingerStates = {}, ripples = [];

const canvas = document.getElementById('output_canvas');
const ctx = canvas.getContext('2d');
const video = document.getElementById('input_video');

async function startApp() {
    try {
        await Tone.start();
        // Crash-Proof Synth: Low CPU FM
        synth = new Tone.PolySynth(Tone.FMSynth).toDestination();
        synth.set({ harmonicity: 2, modulationIndex: 5, envelope: { attack: 0.2, release: 1 } });
        
        document.getElementById('menu').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        isLive = true;
        initTracking();
    } catch (e) { alert("Audio Error: Please interact with screen first."); }
}

function onResults(results) {
    if(!isLive) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    let rf = false, lf = false;
    let streamHTML = "";

    if (results.multiHandLandmarks) {
        results.multiHandLandmarks.forEach((lm, i) => {
            // MIRROR FIX: We swap the label because CSS is scaling -1
            const side = results.multiHandedness[i].label === "Left" ? "Left" : "Right";
            const isFist = Math.hypot(lm[8].x - lm[0].x, lm[8].y - lm[0].y) < 0.13;
            if(isFist) { if(side === "Right") rf = true; else lf = true; }

            [8, 12, 16, 20].forEach((id) => {
                const tip = lm[id];
                const x = tip.x * canvas.width;
                const y = tip.y * canvas.height;
                const active = tip.y > lm[id-1].y;

                if(active && !isFist) {
                    const note = ['C4','E4','G4','B4','D5'][Math.floor(tip.x * 4)];
                    if(!fingerStates[`${side}_${id}`]) {
                        synth.triggerAttackRelease(note, "4n", undefined, Tone.dbToGain(-15 + (coherence*10)));
                        ripples.push({x, y, r: 5, a: 0.8});
                        fingerStates[`${side}_${id}`] = true;
                    }
                } else { fingerStates[`${side}_${id}`] = false; }
                
                ctx.fillStyle = active ? (coherence > 0.8 ? "#ffaa00" : "#00f2ff") : "white";
                ctx.beginPath(); ctx.arc(x, y, 6, 0, Math.PI*2); ctx.fill();
            });
        });
    }

    // UPDATE PHYSICS
    const stateLabel = document.getElementById('state-text');
    if(rf && lf) {
        coherence = Math.min(coherence + 0.02, 1);
        stateLabel.innerText = "DIVINE SOUL STATE";
        stateLabel.style.color = "#ffaa00";
    } else if(rf) {
        coherence = Math.min(coherence + 0.01, 0.7);
        stateLabel.innerText = "HIGH COHERENCE";
        stateLabel.style.color = "#00f2ff";
    } else {
        coherence = Math.max(coherence - 0.01, 0);
        if(coherence < 0.1) {
            stateLabel.innerText = "ANGELIC MODE";
            stateLabel.style.color = "white";
        }
    }

    // DRAW RIPPLES
    ripples.forEach((r, i) => {
        r.r += 2; r.a -= 0.02;
        ctx.strokeStyle = `rgba(0, 242, 255, ${r.a})`;
        ctx.beginPath(); ctx.arc(r.x, r.y, r.r, 0, Math.PI*2); ctx.stroke();
        if(r.a <= 0) ripples.splice(i, 1);
    });
}

// CRASH-PROOF TRACKER
function initTracking() {
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    // modelComplexity: 0 is the secret to iPad/Android Tablet stability
    hands.setOptions({ maxNumHands: 2, modelComplexity: 0, minDetectionConfidence: 0.6 });
    hands.onResults(onResults);

    const camera = new Camera(video, {
        onFrame: async () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            try { await hands.send({image: video}); } catch(e) { console.log("Frame Skip"); }
        },
        width: 640, height: 480 // Lower resolution prevents mobile CPU crashes
    });
    camera.start();
}
</script>
</body>
</html>
