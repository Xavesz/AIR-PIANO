<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Air Piano Pro | Ultimate Correction</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root { --neon: #00f2ff; --rec: #ff3333; --play: #00ff88; --new: #bf00ff; --stop: #ffa500; --gold: #ffd700; }
        body { margin: 0; background: #000; color: white; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { width: 100vw; height: 100vh; position: absolute; z-index: 5; }
        
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); z-index: 1000; text-align: center; }
        .hidden { display: none !important; }
        .btn { padding: 12px 30px; border: 2px solid var(--neon); background: transparent; color: var(--neon); cursor: pointer; border-radius: 4px; font-weight: bold; margin: 8px; transition: 0.3s; z-index: 1100; pointer-events: auto; }
        .btn:hover { background: var(--neon); color: black; box-shadow: 0 0 20px var(--neon); }

        #hud-dashboard { position: absolute; top: 80px; left: 20px; width: 220px; background: rgba(255,255,255,0.05); border-left: 4px solid var(--neon); padding: 15px; z-index: 500; font-family: monospace; }
        .hud-line { font-size: 0.85rem; margin-bottom: 5px; color: #aaa; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 2px; }
        .hud-active { color: var(--neon); text-shadow: 0 0 5px var(--neon); }
        
        #nav-header { position: absolute; top: 0; width: 100%; display: flex; justify-content: space-between; padding: 15px 25px; box-sizing: border-box; z-index: 600; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        #countdown-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 800; pointer-events: none; text-align: center; }
        #timer-val { font-size: 9rem; font-weight: bold; color: var(--neon); }
        .settings-pane { background: #111; padding: 30px; border-radius: 10px; width: 85%; max-height: 75%; overflow-y: auto; border: 1px solid #333; }
        .slider-row { display: flex; align-items: center; gap: 15px; margin: 12px 0; }
        input[type=range] { flex-grow: 1; accent-color: var(--neon); }
    </style>
</head>
<body>

    <div id="ui-main" class="overlay">
        <h1 style="font-size: 3rem; color: var(--neon); letter-spacing: 5px;">AIR PIANO <span style="color:white">PRO</span></h1>
        <button class="btn" onclick="startPerformance()">LAUNCH STAGE</button>
        <button class="btn" onclick="showPane('settings')">MIXER & SETTINGS</button>
        <button class="btn" onclick="showPane('library')">SAVED TUNES</button>
        <button class="btn" onclick="showPane('how-to')">HOW TO USE</button>
    </div>

    <div id="ui-how-to" class="overlay hidden">
        <div class="settings-pane">
            <h2>SYSTEM MANUAL</h2>
            <p>1. <b>Right Fist (3s):</b> Record / Stop</p>
            <p>2. <b>Left Fist (3s):</b> Play Loop (Must be Stopped first)</p>
            <p>3. <b>Open Both Hands (7s):</b> Save Tune to Library</p>
            <p>4. <b>Both Fists (5s):</b> Reset / New Session</p>
            <button class="btn" onclick="showPane('main')">BACK TO MENU</button>
        </div>
    </div>

    <div id="ui-settings" class="overlay hidden">
        <div class="settings-pane">
            <h3>FINGER AUDIO MIXER</h3>
            <div id="mixer-container"></div>
        </div>
        <button class="btn" onclick="showPane('main')">SAVE & BACK</button>
    </div>

    <div id="ui-library" class="overlay hidden">
        <div class="settings-pane">
            <h3>SAVED TUNES LIBRARY</h3>
            <div id="library-content">No recordings found.</div>
        </div>
        <button class="btn" onclick="showPane('main')">BACK TO MENU</button>
    </div>

    <div id="nav-header" class="hidden">
        <button class="btn" style="margin:0" onclick="exitToMenu()">MENU</button>
        <div id="mode-pill" style="color: var(--neon); border: 1px solid var(--neon); padding: 5px 15px; border-radius: 4px; font-weight: bold;">PERFORM</div>
    </div>

    <div id="hud-dashboard" class="hidden">
        <div style="color: var(--neon); margin-bottom: 10px; font-size: 0.7rem;">LIVE TRACKING</div>
        <div id="finger-data-list"></div>
    </div>

    <div id="countdown-box" class="hidden">
        <div id="timer-msg" style="text-transform: uppercase; letter-spacing: 3px;">RECORDING</div>
        <div id="timer-val">3</div>
    </div>

    <canvas id="output_canvas"></canvas>
    <video id="input_video" style="display:none" playsinline></video>

<script>
let synth, currentMode = 'PERFORM', isLive = false, library = [], recording = [];
let startTime = 0, rFistTime = 0, lFistTime = 0, bothOpenTime = 0, bothFistTime = 0;
const notes = ['C3','D3','E3','F3','G3','A3','B3','C4','D4','E4','F4','G4','A4','B4','C5'];
let fingerStates = {}, ripples = [], fingerVols = Array(10).fill(-6);

const video = document.getElementById('input_video');
const canvas = document.getElementById('output_canvas');
const ctx = canvas.getContext('2d');

// --- FIXED NAVIGATION ---
async function startPerformance() {
    if (!synth) {
        await Tone.start();
        synth = new Tone.PolySynth(Tone.Synth).toDestination();
    }
    document.getElementById('ui-main').classList.add('hidden');
    document.querySelectorAll('.hidden').forEach(el => el.classList.remove('hidden'));
    isLive = true;
    startCamera();
}

function showPane(pane) {
    document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
    document.getElementById(`ui-${pane}`).classList.remove('hidden');
    if(pane === 'library') renderLibrary();
}

function exitToMenu() {
    isLive = false;
    showPane('main');
    document.getElementById('nav-header').classList.add('hidden');
    document.getElementById('hud-dashboard').classList.add('hidden');
    document.getElementById('countdown-box').classList.add('hidden');
}

// --- MIXER ---
const mixer = document.getElementById('mixer-container');
const fingerNames = ['L-Pinky','L-Ring','L-Mid','L-Index','L-Thumb','R-Thumb','R-Index','R-Mid','R-Ring','R-Pinky'];
fingerNames.forEach((name, i) => {
    mixer.innerHTML += `<div class="slider-row"><span>${name}</span>
    <input type="range" min="-30" max="0" value="-6" onchange="fingerVols[${i}]=this.value">
    <button class="btn" style="padding:5px 10px" onclick="testSound('${notes[i]}', ${i})">TEST</button></div>`;
});

async function testSound(note, idx) {
    if(!synth) { await Tone.start(); synth = new Tone.PolySynth(Tone.Synth).toDestination(); }
    synth.triggerAttackRelease(note, "8n", undefined, Tone.dbToGain(fingerVols[idx]));
}

// --- PHYSICS (INTERFERENCE) ---
function handleInterference(r1, r2) {
    const dist = Math.hypot(r1.x - r2.x, r1.y - r2.y);
    if (dist < r1.rad + r2.rad && !r1.collidedWith.includes(r2.id)) {
        r1.collidedWith.push(r2.id);
        r2.collidedWith.push(r1.id);
        synth.triggerAttackRelease("E5", "16n", undefined, 0.1);
        return { x: (r1.x + r2.x) / 2, y: (r1.y + r2.y) / 2 };
    }
    return null;
}

function onResults(results) {
    if(!isLive) return;
    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Draw Interference Waves
    ripples.forEach((r, i) => {
        r.rad += 4; r.alpha -= 0.015;
        ctx.strokeStyle = `hsla(${r.hue}, 100%, 70%, ${r.alpha})`;
        ctx.beginPath(); ctx.arc(r.x, r.y, r.rad, 0, Math.PI*2); ctx.stroke();
        ripples.forEach((other, j) => {
            if(i !== j) {
                const intersect = handleInterference(r, other);
                if(intersect) {
                    ctx.fillStyle = "white";
                    ctx.beginPath(); ctx.arc(intersect.x, intersect.y, 5, 0, Math.PI*2); ctx.fill();
                }
            }
        });
        if(r.alpha <= 0) ripples.splice(i, 1);
    });

    let rf = false, lf = false, bo = false, bf = false;
    let hudHtml = "";

    if (results.multiHandLandmarks) {
        results.multiHandLandmarks.forEach((lm, i) => {
            const side = results.multiHandedness[i].label === "Left" ? "Right" : "Left";
            
            // Strict Fist Logic
            const fistDist = Math.hypot(lm[8].x - lm[0].x, lm[8].y - lm[0].y);
            const clench = fistDist < 0.15;
            const openDist = Math.hypot(lm[8].x - lm[0].x, lm[8].y - lm[0].y);
            
            if(clench) { if(side === "Right") rf = true; else lf = true; }
            if(openDist > 0.45) bo = true;

            [4, 8, 12, 16, 20].forEach((id, fIdx) => {
                const tip = lm[id];
                const x = (1-tip.x) * canvas.width;
                const y = tip.y * canvas.height;
                const isBent = tip.y > lm[id-1].y;
                
                if(isBent && !clench) {
                    const nIdx = Math.floor((1-tip.x) * (notes.length-1));
                    const note = notes[nIdx];
                    hudHtml += `<div class="hud-line hud-active">${side} Finger ${fIdx} -> ${note}</div>`;
                    
                    if(!fingerStates[`${side}_${id}`] && (currentMode==='PERFORM' || currentMode==='RECORDING')) {
                        const vol = Tone.dbToGain(fingerVols[fIdx + (side==='Right'?5:0)]);
                        synth.triggerAttackRelease(note, "4n", undefined, vol);
                        ripples.push({x, y, rad: 5, alpha: 1.0, note, hue: nIdx * 25, id: Date.now()+Math.random(), collidedWith: []});
                        if(currentMode === 'RECORDING') recording.push({note, time: Date.now()-startTime});
                        fingerStates[`${side}_${id}`] = true;
                    }
                } else { fingerStates[`${side}_${id}`] = false; }
                
                ctx.fillStyle = isBent ? "var(--gold)" : "white";
                ctx.beginPath(); ctx.arc(x, y, 6, 0, Math.PI*2); ctx.fill();
            });
        });
        if(rf && lf) bf = true;
    }
    document.getElementById('finger-data-list').innerHTML = hudHtml;

    // --- STATE MACHINE ---
    const now = Date.now();
    const box = document.getElementById('countdown-box');
    const val = document.getElementById('timer-val');
    const msg = document.getElementById('timer-msg');

    if (rf && !lf) {
        if(!rFistTime) rFistTime = now;
        let elap = Math.floor((now-rFistTime)/1000);
        box.classList.remove('hidden'); val.innerText = 3-elap;
        msg.innerText = currentMode==='RECORDING' ? "STOPPING" : "RECORDING";
        val.style.color = currentMode==='RECORDING' ? "var(--stop)" : "var(--rec)";
        if(elap >= 3) {
            currentMode = currentMode==='RECORDING'?'STOP':'RECORDING';
            if(currentMode==='RECORDING') { recording=[]; startTime=now; }
            rFistTime = now+4000; box.classList.add('hidden');
        }
    } else if (lf && !rf && currentMode === 'STOP') {
        if(!lFistTime) lFistTime = now;
        box.classList.remove('hidden'); val.innerText = 3-Math.floor((now-lFistTime)/1000);
        msg.innerText = "PLAYING"; val.style.color = "var(--play)";
        if(now-lFistTime >= 3000) {
            currentMode = 'PLAY'; box.classList.add('hidden');
            recording.forEach(e => setTimeout(()=>synth.triggerAttackRelease(e.note,"4n"), e.time));
            setTimeout(()=>currentMode='STOP', (recording[recording.length-1]?.time || 0)+1000);
            lFistTime = now+4000;
        }
    } else if (bf && currentMode === 'STOP') {
        if(!bothFistTime) bothFistTime = now;
        box.classList.remove('hidden'); val.innerText = 5-Math.floor((now-bothFistTime)/1000);
        msg.innerText = "RESETTING"; val.style.color = "var(--new)";
        if(now-bothFistTime >= 5000) { recording=[]; currentMode='PERFORM'; bothFistTime=now+5000; }
    } else if (results.multiHandLandmarks?.length === 2 && bo && currentMode === 'STOP') {
        if(!bothOpenTime) bothOpenTime = now;
        box.classList.remove('hidden'); val.innerText = 7-Math.floor((now-bothOpenTime)/1000);
        msg.innerText = "SAVING"; val.style.color = "var(--neon)";
        if(now-bothOpenTime >= 7000) { 
            library.push({name: "Tune " + (library.length+1), data: [...recording]}); 
            bothOpenTime=now+4000; val.innerText="SAVED";
            setTimeout(()=>box.classList.add('hidden'), 2000);
        }
    } else {
        rFistTime = lFistTime = bothFistTime = bothOpenTime = 0;
        box.classList.add('hidden');
    }
    document.getElementById('mode-pill').innerText = currentMode;
    ctx.restore();
}

function renderLibrary() {
    const content = document.getElementById('library-content');
    if(library.length === 0) { content.innerHTML = "No recordings found."; return; }
    content.innerHTML = library.map((tune, i) => `
        <div style="background:#222; margin:10px; padding:15px; border-radius:5px; display:flex; justify-content:space-between; align-items:center;">
            <span>${tune.name} (${tune.data.length} notes)</span>
            <button class="btn" onclick="playStored(${i})">PLAY VLC</button>
        </div>
    `).join('');
}

function playStored(idx) {
    const tune = library[idx].data;
    tune.forEach(e => setTimeout(() => synth.triggerAttackRelease(e.note, "4n"), e.time));
}

const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.8 });
hands.onResults(onResults);

function startCamera() {
    new Camera(video, {
        onFrame: async () => {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            await hands.send({image: video});
        }, width: 1280, height: 720
    }).start();
}
</script>
</body>
</html>
