<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Air Piano Quantum | Angelic Synthesis</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root { --quantum: #bf00ff; --angelic: #00f2ff; --bg: #050510; }
        body { margin: 0; background: var(--bg); color: white; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { width: 100vw; height: 100vh; position: absolute; z-index: 5; }
        
        /* GUI Layers */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #0a0a25 0%, #000 100%); z-index: 1000; transition: opacity 0.5s ease; }
        .hidden { opacity: 0 !important; pointer-events: none; visibility: hidden; }
        
        .btn { padding: 18px 40px; border: 1px solid var(--angelic); background: transparent; color: var(--angelic); cursor: pointer; border-radius: 50px; font-weight: bold; text-transform: uppercase; letter-spacing: 4px; transition: 0.3s; box-shadow: 0 0 15px rgba(0,242,255,0.2); }
        .btn:hover { background: var(--angelic); color: #000; box-shadow: 0 0 40px var(--angelic); }

        #hud-top { position: absolute; top: 0; width: 100%; display: flex; justify-content: space-between; padding: 25px; box-sizing: border-box; z-index: 500; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); border-bottom: 1px solid rgba(191,0,255,0.2); }
        
        #midi-stream { position: absolute; top: 110px; left: 25px; width: 220px; font-family: 'Courier New', monospace; font-size: 0.8rem; background: rgba(0,0,0,0.5); padding: 15px; border-left: 2px solid var(--quantum); border-radius: 4px; pointer-events: none; z-index: 500; }

        .manual-card { background: rgba(255,255,255,0.03); padding: 25px; border-radius: 15px; border: 1px solid #333; margin: 20px; max-width: 400px; text-align: left; line-height: 1.6; }
        .manual-card b { color: var(--angelic); }
        
        #loading-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; pointer-events: none; display: none; }
        .spinner { width: 100px; height: 100px; border: 3px solid transparent; border-top-color: var(--quantum); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="menu-main" class="ui-layer">
        <h1 style="font-size: 3rem; letter-spacing: 12px; margin-bottom: 0;">QUANTUM <span style="color:var(--angelic)">AIR</span></h1>
        <div class="manual-card">
            <b>HOW TO PLAY:</b><br>
            ‚Ä¢ üñê <b>Play:</b> Move fingers. Wave-like motions create angelic resonance.<br>
            ‚Ä¢ ‚úä <b>Mute:</b> Clench fist to silence the quantum stream.<br>
            ‚Ä¢ üîÅ <b>Reset:</b> Both fists for 3s clears all audio echoes.<br>
            ‚Ä¢ ‚öôÔ∏è <b>Tip:</b> Best used in well-lit areas.
        </div>
        <button class="btn" onclick="initStage()">ACTIVATE STAGE</button>
    </div>

    <div id="hud-top" class="hidden">
        <button class="btn" style="padding: 10px 20px; font-size: 0.7rem;" onclick="location.reload()">TERMINATE</button>
        <div style="text-align: right">
            <div id="mode-text" style="color: var(--angelic); font-weight: bold; letter-spacing: 2px;">ANGELIC MODE</div>
            <div id="hand-stat" style="font-size: 0.7rem; color: #666;">COHERENCE: 0%</div>
        </div>
    </div>

    <div id="midi-stream" class="hidden">
        <div style="opacity: 0.5; margin-bottom: 5px;">QUANTUM DATA:</div>
        <div id="live-data">Waiting for detection...</div>
    </div>

    <canvas id="output_canvas"></canvas>
    <video id="input_video" style="display:none" playsinline></video>

<script>
let synth, isLive = false;
let startTime = 0, bothFistStart = 0;
const notes = ['C4','D4','E4','F4','G4','A4','B4','C5','D5','E5','F5','G5','A5','B5','C6'];
let fingerStates = {}, ripples = [];

const canvas = document.getElementById('output_canvas');
const ctx = canvas.getContext('2d');
const video = document.getElementById('input_video');

// ANGELIC QUANTUM SYNTH ENGINE
async function initStage() {
    await Tone.start();
    // Custom FMSynth: Harmonic, Bell-like, and Quantum-shimmer
    synth = new Tone.PolySynth(Tone.FMSynth, {
        harmonicity: 3.5,
        modulationIndex: 10,
        oscillator: { type: "sine" },
        envelope: { attack: 0.2, decay: 0.3, sustain: 0.4, release: 1.2 },
        modulation: { type: "triangle" },
        modulationEnvelope: { attack: 0.5, decay: 0 }
    }).toDestination();
    
    // Add Reverb for "Angelic" feel
    const reverb = new Tone.Reverb(3).toDestination();
    synth.connect(reverb);

    document.getElementById('menu-main').classList.add('hidden');
    document.getElementById('hud-top').classList.remove('hidden');
    document.getElementById('midi-stream').classList.remove('hidden');
    
    isLive = true;
    startCamera();
}

function onResults(results) {
    if(!isLive) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Smooth Visualizer Ripples
    ripples.forEach((r, i) => {
        r.rad += 3; r.alpha -= 0.015;
        ctx.strokeStyle = `rgba(191,0,255,${r.alpha})`;
        ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(r.x, r.y, r.rad, 0, Math.PI*2); ctx.stroke();
        if(r.alpha <= 0) ripples.splice(i, 1);
    });

    let handCount = results.multiHandLandmarks ? results.multiHandLandmarks.length : 0;
    document.getElementById('hand-stat').innerText = `COHERENCE: ${handCount * 50}%`;

    let dataHTML = "";
    let anyFist = false;
    let rf = false, lf = false;

    if (results.multiHandLandmarks) {
        results.multiHandLandmarks.forEach((lm, i) => {
            const label = results.multiHandedness[i].label; // Left/Right
            const isFist = Math.hypot(lm[8].x - lm[0].x, lm[8].y - lm[0].y) < 0.13;
            if(isFist) { 
                anyFist = true; 
                if(label === "Left") lf = true; else rf = true;
            }

            // Finger Tracking
            [8, 12, 16, 20].forEach((id, fIdx) => {
                const tip = lm[id];
                const x = (1-tip.x) * canvas.width, y = tip.y * canvas.height;
                const active = tip.y > lm[id-1].y; // Natural finger bend trigger

                if(active && !anyFist) {
                    const nIdx = Math.floor((1-tip.x) * (notes.length-1));
                    const note = notes[nIdx];
                    
                    dataHTML += `<div style="color:var(--angelic)">${label} Quantum ‚Üí ${note}</div>`;

                    if(!fingerStates[`${label}_${id}`]) {
                        synth.triggerAttackRelease(note, "2n", undefined, 0.5);
                        ripples.push({x, y, rad: 5, alpha: 0.8, hue: nIdx*20});
                        fingerStates[`${label}_${id}`] = true;
                    }
                } else { fingerStates[`${label}_${id}`] = false; }
                
                // Draw Quantum Particle
                ctx.fillStyle = active ? "var(--angelic)" : "white";
                ctx.beginPath(); ctx.arc(x, y, 6, 0, Math.PI*2); ctx.fill();
            });
        });

        // Both Fists Reset Logic
        if(rf && lf) {
            if(!bothFistStart) bothFistStart = Date.now();
            if(Date.now() - bothFistStart > 3000) {
                synth.releaseAll();
                bothFistStart = Date.now() + 5000;
                document.getElementById('mode-text').innerText = "SYSTEM RESET";
                setTimeout(() => document.getElementById('mode-text').innerText = "ANGELIC MODE", 1000);
            }
        } else { bothFistStart = 0; }
    }
    document.getElementById('live-data').innerHTML = dataHTML || "Listening...";
}

// Low-Latency Camera Loop
const handTracker = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
handTracker.setOptions({ maxNumHands: 2, modelComplexity: 0, minDetectionConfidence: 0.7 });
handTracker.onResults(onResults);

function startCamera() {
    new Camera(video, {
        onFrame: async () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            await handTracker.send({image: video});
        },
        width: 1280, height: 720
    }).start();
}
</script>
</body>
</html>
