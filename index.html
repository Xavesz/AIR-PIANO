<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Air Piano Pro | Quantum Edition</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root { --neon: #00f2ff; --gold: #ffd700; --casio: #ff00ff; }
        body { margin: 0; background: #000; color: white; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { width: 100vw; height: 100vh; position: absolute; }
        
        /* Professional Side HUD */
        #side-hud { position: absolute; top: 100px; right: 20px; width: 220px; background: rgba(255,255,255,0.05); border-right: 3px solid var(--neon); padding: 15px; z-index: 500; font-family: monospace; }
        .hud-line { margin-bottom: 10px; font-size: 0.9rem; border-bottom: 1px solid #222; padding-bottom: 5px; }

        /* Menu Overlay */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); z-index: 1000; }
        .hidden { display: none !important; }
        
        .btn { padding: 12px 30px; border: 2px solid var(--neon); background: transparent; color: var(--neon); cursor: pointer; border-radius: 4px; font-weight: bold; margin: 10px; transition: 0.3s; }
        .btn:hover { background: var(--neon); color: black; box-shadow: 0 0 20px var(--neon); }
        
        #countdown-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 800; text-align: center; pointer-events: none; }
        #timer-num { font-size: 9rem; font-weight: bold; }

        .type-selector { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 500; }
        .active-type { border-color: white !important; color: white !important; background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <div id="ui-main" class="overlay">
        <h1 style="color: var(--neon); letter-spacing: 5px;">AIR PIANO PRO</h1>
        <p>1. Right Fist (3s): REC | 2. Left Fist (3s): PLAY | 3. Hands Spread (7s): SAVE</p>
        <button class="btn" onclick="initStage()">START PERFORMANCE</button>
        <button class="btn" onclick="showLibrary()">VIEW SAVED TUNES</button>
    </div>

    <div id="side-hud" class="hidden">
        <div style="color:var(--neon); margin-bottom: 10px;">ðŸ”´ LIVE DATA</div>
        <div class="hud-line">HAND: <span id="hud-hand">--</span></div>
        <div class="hud-line">FINGER: <span id="hud-finger">--</span></div>
        <div class="hud-line">TUNE: <span id="hud-note">--</span></div>
        <div class="hud-line">MODE: <span id="hud-mode">PERFORM</span></div>
    </div>

    <div class="type-selector hidden" id="type-ui">
        <button class="btn active-type" id="btn-grand" onclick="setPiano('grand')">GRAND</button>
        <button class="btn" id="btn-classic" onclick="setPiano('classic')">CLASSIC</button>
        <button class="btn" id="btn-casio" onclick="setPiano('casio')">CASIO</button>
        <button class="btn" style="border-color: #777; color:#777" onclick="exitToMenu()">MENU</button>
    </div>

    <div id="countdown-ui" class="hidden">
        <div id="timer-msg" style="font-size: 1.5rem; letter-spacing: 5px;">SAVING IN</div>
        <div id="timer-num">7</div>
    </div>

    <canvas id="output_canvas"></canvas>
    <video id="input_video" style="display:none" playsinline></video>

<script>
let synth, currentMode = 'PERFORM', isLive = false, library = [], recording = [];
let startTime = 0, rFistTime = 0, lFistTime = 0, saveTime = 0;
const notes = ['C3','D3','E3','F3','G3','A3','B3','C4','D4','E4','F4','G4','A4','B4','C5'];
let fingerStates = {}, ripples = [];

// Initialize Piano Types
const pianoSettings = {
    grand: { oscillator: { type: "sine" }, envelope: { attack: 0.1, release: 2 } },
    classic: { oscillator: { type: "triangle" }, envelope: { attack: 0.05, release: 1 } },
    casio: { oscillator: { type: "square" }, envelope: { attack: 0.01, release: 0.5 } }
};

async function initStage() {
    await Tone.start();
    setPiano('grand');
    document.getElementById('ui-main').classList.add('hidden');
    document.getElementById('side-hud').classList.remove('hidden');
    document.getElementById('type-ui').classList.remove('hidden');
    isLive = true;
    startCamera();
}

function setPiano(type) {
    if (synth) synth.dispose();
    synth = new Tone.PolySynth(Tone.Synth, pianoSettings[type]).toDestination();
    document.querySelectorAll('.type-selector .btn').forEach(b => b.classList.remove('active-type'));
    document.getElementById(`btn-${type}`).classList.add('active-type');
}

function onResults(results) {
    if(!isLive) return;
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // RIPPLE & INTERFERENCE ENGINE
    ripples.forEach((r, i) => {
        r.rad += 3; r.alpha -= 0.015;
        
        // Check for Collision (Interference)
        ripples.forEach((other, j) => {
            if (i !== j) {
                const dist = Math.hypot(r.x - other.x, r.y - other.y);
                if (dist < r.rad + other.rad && !r.interfered) {
                    // Konstruktive Interference Effect
                    ctx.strokeStyle = `rgba(255, 255, 255, ${r.alpha})`;
                    ctx.lineWidth = 4;
                    ctx.beginPath(); ctx.arc((r.x+other.x)/2, (r.y+other.y)/2, 5, 0, Math.PI*2); ctx.stroke();
                    synth.triggerAttackRelease(Tone.Frequency(r.note).transpose(12), "16n", undefined, 0.2);
                    r.interfered = true;
                }
            }
        });

        ctx.strokeStyle = r.color;
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(r.x, r.y, r.rad, 0, Math.PI*2); ctx.stroke();
        if(r.alpha <= 0) ripples.splice(i, 1);
    });

    let rf = false, lf = false, openHands = false;

    if (results.multiHandLandmarks) {
        results.multiHandLandmarks.forEach((lm, hIdx) => {
            const side = results.multiHandedness[hIdx].label === "Left" ? "Right" : "Left";
            
            // Fist detection logic
            const wrist = lm[0];
            const distSum = [8,12,16].reduce((a, b) => a + Math.hypot(lm[b].x - wrist.x, lm[b].y - wrist.y), 0);
            const isFist = (distSum/3) < 0.14;
            const isFullyOpen = (distSum/3) > 0.45;

            if(isFist) { if(side === "Right") rf = true; else lf = true; }
            if(isFullyOpen) openHands = results.multiHandLandmarks.length === 2;

            if(!isFist) {
                [4, 8, 12, 16, 20].forEach((id, fIdx) => {
                    const tip = lm[id];
                    const x = (1-tip.x) * canvas.width;
                    const y = tip.y * canvas.height;
                    const isBent = tip.y > lm[id-1].y;

                    if(isBent && !fingerStates[`${side}_${id}`]) {
                        if(currentMode === 'PERFORM' || currentMode === 'RECORDING') {
                            const n = notes[Math.floor((1-tip.x)*(notes.length-1))];
                            synth.triggerAttackRelease(n, "4n");
                            
                            // Visual HUD Update
                            document.getElementById('hud-hand').innerText = side;
                            document.getElementById('hud-finger').innerText = ["Thumb","Index","Middle","Ring","Pinky"][fIdx];
                            document.getElementById('hud-note').innerText = n;

                            ripples.push({x, y, rad: 5, alpha: 1, note: n, color: `hsla(${fIdx*40}, 100%, 50%, 0.8)`, interfered: false});
                            if(currentMode === 'RECORDING') recording.push({note: n, time: Date.now() - startTime});
                            fingerStates[`${side}_${id}`] = true;
                        }
                    } else if(!isBent) fingerStates[`${side}_${id}`] = false;
                });
            }
        });
    }

    // STATE MACHINE (COUNTDOWNS)
    const now = Date.now();
    const timerUI = document.getElementById('countdown-ui');
    const timerNum = document.getElementById('timer-num');
    const timerMsg = document.getElementById('timer-msg');

    if(openHands && currentMode === 'STOP') { // SAVE (7s)
        if(!saveTime) saveTime = now;
        timerUI.classList.remove('hidden');
        timerMsg.innerText = "SAVING IN";
        let elap = Math.floor((now-saveTime)/1000);
        timerNum.innerText = 7 - elap;
        if(elap >= 7) {
            localStorage.setItem('airTune_' + Date.now(), JSON.stringify(recording));
            timerNum.innerText = "SAVED"; saveTime = now + 9000;
        }
    } else if (rf && !lf) { // REC Toggle (3s)
        if(!rFistTime) rFistTime = now;
        timerUI.classList.remove('hidden');
        timerMsg.innerText = currentMode === 'RECORDING' ? "STOPPING IN" : "RECORDING IN";
        let elap = Math.floor((now-rFistTime)/1000);
        timerNum.innerText = 3 - elap;
        if(elap >= 3) {
            currentMode = currentMode === 'RECORDING' ? 'STOP' : 'RECORDING';
            if(currentMode === 'RECORDING') { recording = []; startTime = Date.now(); }
            rFistTime = now + 5000; timerUI.classList.add('hidden');
        }
    } else {
        saveTime = rFistTime = 0;
        timerUI.classList.add('hidden');
    }
    document.getElementById('hud-mode').innerText = currentMode;
    ctx.restore();
}

function startCamera() {
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.8 });
    hands.onResults(onResults);
    new Camera(video, { onFrame: async () => {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        await hands.send({image: video});
    }, width: 1280, height: 720 }).start();
}
</script>
</body>
</html>
