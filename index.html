<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Cyber Piano - Pro Edition</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" crossorigin="anonymous"></script>

    <style>
        :root { --neon: #00f2ff; --bg: #0a0a0f; }
        body { margin: 0; background: var(--bg); color: white; overflow: hidden; font-family: 'Courier New', Courier, monospace; }
        canvas { width: 100vw; height: 100vh; transform: scaleX(-1); }
        
        /* Futuristic UI */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #1a1a2e 0%, #0a0a0f 100%); z-index: 100; text-align: center; }
        .hidden { display: none !important; }
        
        button { padding: 20px 60px; font-size: 1.2rem; background: transparent; color: var(--neon); border: 2px solid var(--neon); border-radius: 5px; cursor: pointer; text-transform: uppercase; letter-spacing: 5px; box-shadow: 0 0 15px var(--neon); transition: 0.3s; }
        button:hover { background: var(--neon); color: black; }

        /* Diagnostic HUD */
        #hud { position: absolute; top: 20px; left: 20px; width: 220px; padding: 15px; background: rgba(0, 242, 255, 0.1); border-left: 3px solid var(--neon); font-size: 12px; pointer-events: none; }
        .active-key { color: #ff0055; font-weight: bold; }
    </style>
</head>
<body>

    <div id="welcome" class="overlay">
        <h1 style="letter-spacing: 10px;">CYBER PIANO</h1>
        <p style="color: #666;">BEND YOUR FINGERS TO PLAY â€¢ NO BORDERS</p>
        <button id="startBtn">INITIALIZE SYSTEM</button>
    </div>

    <div id="hud">
        <div style="color: var(--neon); margin-bottom: 10px;">SYSTEM DIAGNOSTICS</div>
        <div id="handCount">HANDS DETECTED: 0</div>
        <div id="fingerStatus">ACTIVE: NONE</div>
        <div id="lastNote">LAST NOTE: ---</div>
    </div>

    <canvas id="output_canvas"></canvas>
    <video id="input_video" style="display:none" playsinline></video>

<script>
let synth;
let audioStarted = false;
const videoElement = document.getElementById('input_video');
const canvasElement = document.getElementById('output_canvas');
const canvasCtx = canvasElement.getContext('2d');
const notes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
let fingerState = Array(10).fill(false); // Track if finger is currently "bent"

document.getElementById('startBtn').onclick = async () => {
    await Tone.start();
    synth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "amsine" },
        envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.8 }
    }).toDestination();
    audioStarted = true;
    document.getElementById('welcome').classList.add('hidden');
    startCamera();
};

function checkCurl(landmarks, tipIdx) {
    const wrist = landmarks[0];
    const knuckle = landmarks[tipIdx - 3]; // Knuckle for that finger
    const tip = landmarks[tipIdx];
    
    // Distance formula: sqrt((x2-x1)^2 + (y2-y1)^2)
    const distWristTip = Math.hypot(tip.x - wrist.x, tip.y - wrist.y);
    const distWristKnuckle = Math.hypot(knuckle.x - wrist.x, knuckle.y - wrist.y);
    
    // If tip is closer to wrist than the knuckle is, the finger is "curled/bent"
    return distWristTip < distWristKnuckle * 1.2; 
}

function onResults(results) {
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

    // Dynamic Visuals (No Hard Borders)
    const w = canvasElement.width / notes.length;
    
    if (results.multiHandLandmarks && audioStarted) {
        document.getElementById('handCount').innerText = `HANDS DETECTED: ${results.multiHandLandmarks.length}`;
        let activeFingers = [];

        results.multiHandLandmarks.forEach((landmarks, hIdx) => {
            const fingerTips = [4, 8, 12, 16, 20];
            const fingerNames = ["Thumb", "Index", "Middle", "Ring", "Pinky"];

            fingerTips.forEach((tipId, fIdx) => {
                const isBent = checkCurl(landmarks, tipId);
                const globalIdx = fIdx + (hIdx * 5);
                const tip = landmarks[tipId];
                const x = tip.x * canvasElement.width;
                const y = tip.y * canvasElement.height;

                if (isBent) {
                    activeFingers.push(fingerNames[fIdx]);
                    if (!fingerState[globalIdx]) {
                        const lane = Math.floor(tip.x * notes.length);
                        synth.triggerAttack(notes[lane]);
                        document.getElementById('lastNote').innerText = `LAST NOTE: ${notes[lane]}`;
                        
                        // Short time play: Fade out even if held
                        setTimeout(() => synth.triggerRelease(notes[lane]), 600);
                        fingerState[globalIdx] = true;
                    }
                } else {
                    fingerState[globalIdx] = false;
                }

                // Draw Cyber-Glow for fingers
                canvasCtx.shadowBlur = isBent ? 20 : 0;
                canvasCtx.shadowColor = "#00f2ff";
                canvasCtx.fillStyle = isBent ? "#ff0055" : "rgba(0, 242, 255, 0.5)";
                canvasCtx.beginPath();
                canvasCtx.arc(x, y, isBent ? 15 : 8, 0, 2 * Math.PI);
                canvasCtx.fill();
            });
        });
        document.getElementById('fingerStatus').innerText = `ACTIVE: ${activeFingers.join(', ') || 'NONE'}`;
    }
    canvasCtx.restore();
}

const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.7 });
hands.onResults(onResults);

function startCamera() {
    new Camera(videoElement, {
        onFrame: async () => {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            await hands.send({image: videoElement});
        },
        width: 1280, height: 720
    }).start();
}
</script>
</body>
</html>
