<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Air Piano - Secure Edition</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" crossorigin="anonymous"></script>

    <style>
        :root { --accent: #00f2ff; }
        body { margin: 0; background: #050505; color: white; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        canvas { width: 100vw; height: 100vh; transform: scaleX(-1); filter: drop-shadow(0 0 10px rgba(0,242,255,0.2)); }
        
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); z-index: 100; transition: 0.5s; }
        .hidden { opacity: 0; pointer-events: none; }
        
        button { padding: 20px 40px; font-size: 1.5rem; font-weight: bold; background: var(--accent); border: none; border-radius: 50px; cursor: pointer; color: black; box-shadow: 0 0 20px var(--accent); }
        button:active { transform: scale(0.95); }

        .status-bar { position: absolute; top: 10px; width: 100%; text-align: center; font-size: 12px; letter-spacing: 2px; color: var(--accent); text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="welcome" class="overlay">
        <h1 style="margin-bottom: 10px;">3D AIR PIANO</h1>
        <p style="margin-bottom: 30px; color: #aaa;">Place device on desk â€¢ Use 10 fingers in air</p>
        <button onclick="initApp()">ACTIVATE SENSORS</button>
    </div>

    <div class="status-bar" id="status">Waiting for Camera...</div>
    
    <canvas id="output_canvas"></canvas>
    <video id="input_video" style="display:none" playsinline></video>

<script>
const videoElement = document.getElementById('input_video');
const canvasElement = document.getElementById('output_canvas');
const canvasCtx = canvasElement.getContext('2d');
const statusText = document.getElementById('status');

// 1. Setup Sound (High Quality)
const synth = new Tone.PolySynth(Tone.Synth, {
    oscillator: { type: "triangle" },
    envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1 }
}).toDestination();

const notes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
let lastPlayed = Array(10).fill(0); 

async function initApp() {
    await Tone.start();
    document.getElementById('welcome').classList.add('hidden');
    statusText.innerText = "Sensors Active - Tracking 10 Fingers";
    startCamera();
}

// 2. AI Hand Tracking Logic
function onResults(results) {
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

    // Draw Piano Visualizer
    const w = canvasElement.width / notes.length;
    notes.forEach((_, i) => {
        canvasCtx.strokeStyle = "rgba(0, 242, 255, 0.15)";
        canvasCtx.strokeRect(i * w, canvasElement.height - 150, w, 150);
    });

    if (results.multiHandLandmarks) {
        results.multiHandLandmarks.forEach((landmarks, handIdx) => {
            // Track Finger Tips: Thumb(4), Index(8), Middle(12), Ring(16), Pinky(20)
            const fingerTips = [4, 8, 12, 16, 20];
            
            fingerTips.forEach((id, fIdx) => {
                const tip = landmarks[id];
                const x = tip.x * canvasElement.width;
                const y = tip.y * canvasElement.height;
                const depth = tip.z; // The "Pixel Depth" value

                // DRAW FINGERMARKERS
                canvasCtx.fillStyle = depth < -0.1 ? "#ff0055" : "#00f2ff";
                canvasCtx.beginPath();
                canvasCtx.arc(x, y, 12, 0, 2 * Math.PI);
                canvasCtx.fill();

                // 3. COLLISION DETECTION (THE PIANO HIT)
                const lane = Math.floor(tip.x * notes.length);
                const now = Date.now();
                
                // If finger is in the bottom half and depth is "pressed"
                if (tip.y > 0.6 && depth < -0.12) {
                    // Prevent rapid double-triggering (debounce)
                    if (now - lastPlayed[fIdx + (handIdx * 5)] > 300) {
                        synth.triggerAttackRelease(notes[lane], "8n");
                        lastPlayed[fIdx + (handIdx * 5)] = now;
                        
                        // Flash effect on hit
                        canvasCtx.fillStyle = "rgba(0, 242, 255, 0.3)";
                        canvasCtx.fillRect(lane * w, 0, w, canvasElement.height);
                    }
                }
            });
        });
    }
    canvasCtx.restore();
}

const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({ 
    maxNumHands: 2, 
    modelComplexity: 1, 
    minDetectionConfidence: 0.7, 
    minTrackingConfidence: 0.7 
});
hands.onResults(onResults);

function startCamera() {
    const camera = new Camera(videoElement, {
        onFrame: async () => {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            await hands.send({image: videoElement});
        },
        width: 1280, height: 720
    });
    camera.start().catch(() => {
        alert("Camera Error: Please allow camera access and use HTTPS");
    });
}
</script>
</body>
</html>
