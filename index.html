<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Air Piano - Loop Station</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" crossorigin="anonymous"></script>

    <style>
        :root { --neon: #00f2ff; --gold: #ffd700; --red: #ff4d4d; }
        body { margin: 0; background: #000; color: white; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { width: 100vw; height: 100vh; transform: scaleX(-1); }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); z-index: 100; }
        .hidden { display: none !important; }
        button { padding: 25px 50px; font-size: 1.5rem; background: var(--neon); border: none; border-radius: 50px; cursor: pointer; font-weight: bold; }
        #status { position: absolute; top: 20px; width: 100%; text-align: center; color: var(--neon); letter-spacing: 2px; }
    </style>
</head>
<body>

    <div id="welcome" class="overlay">
        <h1>AIR PIANO PRO</h1>
        <p>ðŸ‘Œ Right hand OK: Record Loop | ðŸ‘Œ Left hand OK: Play Loop</p>
        <button id="startBtn">START SYSTEM</button>
    </div>

    <div id="status">MIRROR MODE: ACTIVE</div>
    <canvas id="output_canvas"></canvas>
    <video id="input_video" style="display:none" playsinline></video>

<script>
let synth, recording = [], isRecording = false, loopStartTime = 0;
const videoElement = document.getElementById('input_video');
const canvasElement = document.getElementById('output_canvas');
const canvasCtx = canvasElement.getContext('2d');
const notes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
let fingerStates = {};
let drops = [];

document.getElementById('startBtn').onclick = async () => {
    await Tone.start();
    // Refined High-Quality Piano Synth
    synth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "fatsine4" },
        envelope: { attack: 0.1, decay: 0.3, sustain: 0.4, release: 2 }
    }).toDestination();
    document.getElementById('welcome').classList.add('hidden');
    startCamera();
};

function isOkaySign(landmarks) {
    const thumb = landmarks[4];
    const index = landmarks[8];
    const dist = Math.hypot(thumb.x - index.x, thumb.y - index.y);
    return dist < 0.05; // Very close together
}

function spawnDrop(x, y, note) {
    drops.push({ x, y, note, alpha: 1.0, ySpeed: 4 });
}

function onResults(results) {
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

    // Render Drops
    drops.forEach((d, i) => {
        d.y += d.ySpeed; d.alpha -= 0.015;
        canvasCtx.fillStyle = `rgba(0, 242, 255, ${d.alpha})`;
        canvasCtx.font = "bold 20px sans-serif";
        canvasCtx.fillText(d.note, d.x, d.y);
        if (d.alpha <= 0) drops.splice(i, 1);
    });

    if (results.multiHandLandmarks && results.multiHandedness) {
        results.multiHandLandmarks.forEach((landmarks, hIdx) => {
            // FIX INVERSION: Swap Left/Right labels
            let side = results.multiHandedness[hIdx].label === "Left" ? "Right" : "Left";
            
            // Check for OKAY GESTURE
            if (isOkaySign(landmarks)) {
                if (side === "Right" && !isRecording) {
                    isRecording = true; recording = []; loopStartTime = Date.now();
                    document.getElementById('status').innerText = "ðŸ”´ RECORDING LOOP...";
                }
                if (side === "Left" && recording.length > 0) {
                    playLoop();
                }
            }

            const tips = [4, 8, 12, 16, 20];
            const names = ["Thumb", "Index", "Middle", "Ring", "Pinky"];

            tips.forEach((id, fIdx) => {
                const tip = landmarks[id];
                const x = (1 - tip.x) * canvasElement.width;
                const y = tip.y * canvasElement.height;
                
                // Bend Detection
                const isBent = tip.y > landmarks[id-2].y;
                const key = `${side}_${names[fIdx]}`;

                if (isBent && !fingerStates[key]) {
                    const lane = Math.floor(tip.x * notes.length);
                    const note = notes[lane];
                    synth.triggerAttackRelease(note, "4n");
                    spawnDrop(x, y, note);
                    
                    if (isRecording) {
                        recording.push({ note, time: Date.now() - loopStartTime });
                    }
                    
                    fingerStates[key] = true;
                } else if (!isBent) {
                    fingerStates[key] = false;
                }

                // Visual Glow
                canvasCtx.fillStyle = isBent ? "var(--gold)" : "white";
                canvasCtx.beginPath();
                canvasCtx.arc(x, y, 10, 0, Math.PI*2);
                canvasCtx.fill();
                canvasCtx.fillText(`${side} ${names[fIdx]}`, x - 30, y - 20);
            });
        });
    }
    canvasCtx.restore();
}

function playLoop() {
    document.getElementById('status').innerText = "ðŸŸ¢ PLAYING LOOP...";
    recording.forEach(event => {
        setTimeout(() => synth.triggerAttackRelease(event.note, "4n"), event.time);
    });
}

const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.8 });
hands.onResults(onResults);

function startCamera() {
    new Camera(videoElement, {
        onFrame: async () => {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            await hands.send({image: videoElement});
        }, width: 1280, height: 720
    }).start();
}
</script>
</body>
</html>
