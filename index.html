<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Air Instrument - Pro</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" crossorigin="anonymous"></script>

    <style>
        :root { --neon: #00f2ff; --pink: #ff0055; }
        body { margin: 0; background: #050505; color: white; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { width: 100vw; height: 100vh; transform: scaleX(-1); }
        
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); z-index: 100; transition: 0.5s; }
        .hidden { display: none !important; }
        
        .mode-select { display: flex; gap: 20px; }
        button { padding: 15px 30px; font-size: 1rem; background: transparent; color: var(--neon); border: 2px solid var(--neon); border-radius: 5px; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        button:hover { background: var(--neon); color: black; box-shadow: 0 0 20px var(--neon); }

        #hud { position: absolute; bottom: 20px; left: 20px; width: 240px; height: 160px; border: 2px solid #333; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; padding: 10px; font-size: 12px; }
        .log-box { flex-grow: 1; overflow: hidden; color: #888; }
    </style>
</head>
<body>

    <div id="welcome" class="overlay">
        <h1 style="letter-spacing: 5px;">AIR STUDIO PRO</h1>
        <div class="mode-select">
            <button onclick="initApp('piano')">PIANO MODE</button>
            <button onclick="initApp('drum')">DRUM MODE</button>
        </div>
    </div>

    <div id="hud">
        <div style="color: var(--neon); border-bottom: 1px solid #333; margin-bottom: 5px;">SENSORS & DIAGNOSTICS</div>
        <div id="handInfo">Left: -- | Right: --</div>
        <div id="log" class="log-box"></div>
    </div>

    <canvas id="output_canvas"></canvas>
    <video id="input_video" style="display:none" playsinline></video>

<script>
let synth, sampler, currentMode;
let audioStarted = false;
const videoElement = document.getElementById('input_video');
const canvasElement = document.getElementById('output_canvas');
const canvasCtx = canvasElement.getContext('2d');
const logBox = document.getElementById('log');

const notes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
const drumNotes = ["C1", "D1", "E1", "F1"]; // Kick, Snare, Hi-Hat, Crash
let fingerStates = {}; // Tracking per-finger states
let drops = []; // Raindrop tiles

async function initApp(mode) {
    currentMode = mode;
    await Tone.start();
    
    // Drum sounds (Simple placeholders, better to use samples)
    if (mode === 'drum') {
        synth = new Tone.MembraneSynth().toDestination();
    } else {
        synth = new Tone.PolySynth(Tone.Synth).toDestination();
    }

    document.getElementById('welcome').classList.add('hidden');
    audioStarted = true;
    startCamera();
}

// Advanced Bend Detection (Horizontal + Vertical)
function isFingerBent(landmarks, tipIdx) {
    const wrist = landmarks[0];
    const pip = landmarks[tipIdx - 2]; // Joint
    const tip = landmarks[tipIdx];
    
    // Thumb logic is different (Horizontal bend)
    if (tipIdx === 4) {
        return Math.hypot(tip.x - landmarks[17].x, tip.y - landmarks[17].y) < 0.15;
    }
    
    // Vertical logic for others
    return tip.y > pip.y;
}

function spawnDrop(x, y, note) {
    drops.push({ x, y, speed: 5, note, alpha: 1.0 });
}

function onResults(results) {
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

    // Draw Falling Raindrops
    drops.forEach((d, i) => {
        d.y += d.speed;
        d.alpha -= 0.02;
        canvasCtx.fillStyle = `rgba(0, 242, 255, ${d.alpha})`;
        canvasCtx.beginPath();
        canvasCtx.arc(d.x, d.y, 10, 0, Math.PI * 2);
        canvasCtx.fill();
        if (d.alpha <= 0) drops.splice(i, 1);
    });

    if (results.multiHandLandmarks && results.multiHandedness) {
        results.multiHandLandmarks.forEach((landmarks, hIdx) => {
            const side = results.multiHandedness[hIdx].label; // "Left" or "Right"
            const tips = [4, 8, 12, 16, 20];
            const names = ["Thumb", "Index", "Middle", "Ring", "Pinky"];

            tips.forEach((id, fIdx) => {
                // If Drum mode, only use Index(8) and Middle(12)
                if (currentMode === 'drum' && id !== 8 && id !== 12) return;

                const bent = isFingerBent(landmarks, id);
                const fingerKey = `${side}_${names[fIdx]}`;
                const x = (1 - landmarks[id].x) * canvasElement.width;
                const y = landmarks[id].y * canvasElement.height;

                if (bent && !fingerStates[fingerKey]) {
                    const lane = Math.floor(landmarks[id].x * notes.length);
                    const note = currentMode === 'piano' ? notes[lane] : drumNotes[fIdx % 4];
                    
                    synth.triggerAttackRelease(note, "8n");
                    spawnDrop(x, y, note);
                    
                    // Add Log
                    logBox.innerHTML = `> ${side} ${names[fIdx]} played ${note}<br>` + logBox.innerHTML;
                    fingerStates[fingerKey] = true;

                    // Vibration Glow
                    canvasCtx.shadowBlur = 40;
                    canvasCtx.shadowColor = "var(--pink)";
                } else if (!bent) {
                    fingerStates[fingerKey] = false;
                }

                // Draw Finger Points
                canvasCtx.fillStyle = bent ? "var(--pink)" : "var(--neon)";
                canvasCtx.beginPath();
                canvasCtx.arc(x, y, 12, 0, Math.PI * 2);
                canvasCtx.fill();
                
                // Label above finger
                canvasCtx.fillStyle = "white";
                canvasCtx.font = "12px monospace";
                canvasCtx.fillText(`${side} ${names[fIdx]}`, x - 20, y - 20);
            });
        });
    }
    canvasCtx.restore();
}

const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.75 });
hands.onResults(onResults);

function startCamera() {
    new Camera(videoElement, {
        onFrame: async () => {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            await hands.send({image: videoElement});
        }, width: 1280, height: 720
    }).start();
}
</script>
</body>
</html>
