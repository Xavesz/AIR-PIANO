<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Air Piano Pro | Global Launch</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root { --neon: #00f2ff; --rec: #ff3333; --play: #00ff88; --new: #bf00ff; --stop: #ffa500; --bg: #050508; }
        body { margin: 0; background: var(--bg); color: white; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; }
        
        .menu-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5,5,8,0.95); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
        .hidden { display: none !important; }
        
        .btn { padding: 15px 40px; border: 2px solid var(--neon); background: transparent; color: var(--neon); cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; margin: 10px; transition: 0.3s; }
        .btn:hover { background: var(--neon); color: black; box-shadow: 0 0 20px var(--neon); }
        
        #hud-status { position: absolute; top: 20px; width: 100%; text-align: center; font-size: 1.5rem; font-weight: bold; z-index: 500; text-transform: uppercase; }
        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 8rem; font-weight: bold; z-index: 600; text-align: center; pointer-events: none; }
        
        .settings-pane { background: #111; padding: 20px; border: 1px solid #333; border-radius: 10px; width: 80%; max-height: 70%; overflow-y: auto; }
        .slider-row { display: flex; align-items: center; gap: 15px; margin: 10px 0; }
        input[type=range] { flex-grow: 1; accent-color: var(--neon); }
        
        #vlc-player { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 80%; background: rgba(20,20,30,0.9); padding: 10px; border-radius: 10px; z-index: 500; }
    </style>
</head>
<body>

    <div id="main-menu" class="menu-layer">
        <h1 style="font-size: 3rem; letter-spacing: 10px;">AIR PIANO <span style="color:var(--neon)">PRO</span></h1>
        <button class="btn" onclick="showScene('calibration')">Start Calibration</button>
        <button class="btn" onclick="showScene('settings')">Mixer & Settings</button>
        <button class="btn" onclick="showScene('library')">Saved Tunes</button>
        <button class="btn" onclick="initPerformance()">Launch Performance</button>
    </div>

    <div id="calibration-menu" class="menu-layer hidden">
        <h2 id="calib-msg">Follow the on-screen guide...</h2>
        <div id="calib-finger-icon" style="font-size: 4rem;">üñêÔ∏è</div>
        <button class="btn" onclick="showScene('main')">Back to Menu</button>
    </div>

    <div id="settings-menu" class="menu-layer hidden">
        <div class="settings-pane">
            <h3>AUDIO MIXER</h3>
            <div id="mixer-controls"></div>
            <hr>
            <label><input type="checkbox" id="invert-left"> Invert Left Hand Keys</label>
        </div>
        <button class="btn" onclick="showScene('main')">Save & Back</button>
    </div>

    <div id="library-menu" class="menu-layer hidden">
        <h2>YOUR RECORDINGS</h2>
        <div id="tunes-list" style="width: 80%;"></div>
        <button class="btn" onclick="showScene('main')">Back to Menu</button>
    </div>

    <div id="hud-status"></div>
    <div id="countdown"></div>
    <div id="vlc-player" class="hidden">
        <button id="vlc-pp">PAUSE</button>
        <input type="range" id="vlc-seek" value="0" style="width:70%">
        <button onclick="closeVLC()">CLOSE</button>
    </div>

    <canvas id="output_canvas"></canvas>
    <video id="input_video" style="display:none" playsinline></video>

<script>
// --- CORE VARIABLES ---
let synth, currentScene = 'main', recording = [], savedLibrary = [], isRecording = false, isPlaying = false;
let startTime = 0, rFistStart = 0, lFistStart = 0, prayStart = 0, bothFistStart = 0;
const notes = ['C3','D3','E3','F3','G3','A3','B3','C4','D4','E4','F4','G4','A4','B4','C5'];
let fingerVolumes = Array(10).fill(0.5); // Default volumes

const canvas = document.getElementById('output_canvas');
const ctx = canvas.getContext('2d');
const video = document.getElementById('input_video');

// --- INITIALIZATION ---
async function initPerformance() {
    await Tone.start();
    synth = new Tone.PolySynth(Tone.Synth).toDestination();
    showScene('none');
    startCamera();
}

function showScene(scene) {
    document.querySelectorAll('.menu-layer').forEach(el => el.classList.add('hidden'));
    if(scene !== 'none') document.getElementById(`${scene}-menu`).classList.remove('hidden');
    currentScene = scene;
}

// --- MIXER UI GENERATION ---
const mixer = document.getElementById('mixer-controls');
['L-Thumb','L-Index','L-Mid','L-Ring','L-Pinky','R-Thumb','R-Index','R-Mid','R-Ring','R-Pinky'].forEach((name, i) => {
    mixer.innerHTML += `<div class="slider-row"><span>${name}</span><input type="range" min="0" max="1" step="0.1" value="0.5" onchange="fingerVolumes[${i}]=this.value"><button onclick="testSound(${i})">üîä</button></div>`;
});

function testSound(i) {
    if(!synth) synth = new Tone.PolySynth(Tone.Synth).toDestination();
    synth.triggerAttackRelease(notes[i], "8n", undefined, fingerVolumes[i]);
}

// --- GESTURE DETECTION ---
function getFistData(landmarks) {
    const wrist = landmarks[0];
    const fingers = [8, 12, 16, 20];
    let avg = 0;
    fingers.forEach(id => avg += Math.hypot(landmarks[id].x - wrist.x, landmarks[id].y - wrist.y));
    const pinkyOut = Math.hypot(landmarks[20].x - wrist.x, landmarks[20].y - wrist.y) > 0.25;
    return { isFist: (avg/4) < 0.12, pinkyOut };
}

function isPraying(h1, h2) {
    const d = Math.hypot(h1[9].x - h2[9].x, h1[9].y - h2[9].y);
    return d < 0.1;
}

// --- MAIN LOOP ---
function onResults(results) {
    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const now = Date.now();
    let rf = false, lf = false, hands = [];

    if (results.multiHandLandmarks) {
        results.multiHandLandmarks.forEach((lm, i) => {
            const side = results.multiHandedness[i].label === "Left" ? "Right" : "Left";
            const fistData = getFistData(lm);
            if(fistData.isFist && !fistData.pinkyOut) {
                if(side === "Right") rf = true; else lf = true;
            }
            hands.push({lm, side, isFist: fistData.isFist});

            // Piano Play Logic
            if(!fistData.isFist || fistData.pinkyOut) {
                [4, 8, 12, 16, 20].forEach((id, fIdx) => {
                    const tip = lm[id];
                    const isBent = tip.y > lm[id-1].y;
                    if(isBent && currentScene === 'none') {
                        const x = (1-tip.x) * canvas.width;
                        const noteIdx = Math.floor((1-tip.x) * (notes.length-1));
                        if(!isPlaying) synth.triggerAttackRelease(notes[noteIdx], "8n");
                        // Raindrop logic here...
                    }
                });
            }
        });

        // Countdown System
        const cd = document.getElementById('countdown');
        if(rf && !lf) { // Right Fist -> REC/STOP
            if(!rFistStart) rFistStart = now;
            let elap = Math.floor((now - rFistStart)/1000);
            cd.innerText = isRecording ? `STOPPING IN ${3-elap}` : `RECORDING IN ${3-elap}`;
            cd.style.color = isRecording ? "var(--stop)" : "var(--rec)";
            if(elap >= 3) { isRecording = !isRecording; rFistStart = now + 5000; cd.innerText = ""; }
        } else if(lf && !rf) { // Left Fist -> PLAY
            if(!lClenchStart) lClenchStart = now;
            let elap = Math.floor((now - lClenchStart)/1000);
            cd.innerText = `PLAYING IN ${3-elap}`;
            cd.style.color = "var(--play)";
            // Play logic...
        } else if(rf && lf) { // Both -> RESET
            if(!bothFistStart) bothFistStart = now;
            let elap = Math.floor((now - bothFistStart)/1000);
            cd.innerText = `RESETTING IN ${5-elap}`;
            cd.style.color = "var(--new)";
            if(elap >= 5) { recording = []; bothFistStart = now + 5000; cd.innerText = "NEW"; }
        } else if(hands.length === 2 && isPraying(hands[0].lm, hands[1].lm)) { // Prayer -> SAVE
             if(!prayStart) prayStart = now;
             let elap = Math.floor((now - prayStart)/1000);
             cd.innerText = `SAVING IN ${3-elap}`;
             if(elap >= 3) { savedLibrary.push([...recording]); prayStart = now + 5000; cd.innerText = "SAVED"; }
        } else {
            rFistStart = 0; lClenchStart = 0; bothFistStart = 0; prayStart = 0;
            cd.innerText = "";
        }
    }
    ctx.restore();
}

const handTracker = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
handTracker.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.8 });
handTracker.onResults(onResults);

function startCamera() {
    new Camera(video, {
        onFrame: async () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            await handTracker.send({image: video});
        }, width: 1280, height: 720
    }).start();
}
</script>
</body>
</html>
